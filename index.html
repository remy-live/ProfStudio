<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prof Studio - Design Geosoft</title>
    <style>
        /* --- 1. VARIABLES & THEME GEOSOFT --- */
        :root {
            /* Palette principale */
            --header-bg: hsla(0, 0%, 100%, 0.775);
            --header-text: #2d3436;
            --sidebar-bg: #ffffff;
            --sidebar-border: #dfe6e9;

            /* Couleurs d'accentuation (Violet moderne) */
            --accent: #6c5ce7;
            --accent-hover: #5649c0;
            --accent-bg: #f0f0ff;
            /* Fond l√©ger pour les boutons actifs */

            /* Utilitaires */
            --danger: #d63031;
            --success: #00b894;
            --warning: #fdcb6e;
            --text-muted: #636e72;

            /* Dimensions & UI */
            --header-height: 56px;
            --panel-width: 320px;
            --radius: 8px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            color: #2d3436;
            user-select: none;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f6fa;
        }

        /* --- 2. HEADER --- */
        header {
            height: var(--header-height);
            background-color: var(--header-bg);
            color: var(--header-text);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 4px 2px 4px 2px rgba(0, 0, 0, 0.2);
            z-index: 30;
            flex-shrink: 0;
            border-bottom: 1px solid var(--sidebar-border);
        }

        .header-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .app-title {
            font-weight: 800;
            font-size: 1.3rem;
            color: var(--accent);
            margin-right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toolbar-group {
            display: flex;
            gap: 6px;
            background: transparent;
            padding: 0;
            align-items: center;
        }

        .divider {
            width: 1px;
            height: 28px;
            background: #dfe6e9;
            margin: 0 8px;
        }

        /* Boutons Outils */
        .tool-btn {
            width: 38px;
            height: 38px;
            border: 1px solid transparent;
            background: transparent;
            color: var(--text-muted);
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .tool-btn:hover {
            background: var(--accent-bg);
            color: var(--accent);
        }

        .tool-btn.active {
            background: var(--accent-bg);
            color: var(--accent);
            border-color: rgba(108, 92, 231, 0.2);
            font-weight: bold;
        }

        .tool-btn.edit-mode-active {
            background: #fff3cd;
            color: #e67e22;
            border-color: #ffeeba;
        }

        .tool-btn svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
            stroke: currentColor;
        }

        .icon-stroke {
            fill: none !important;
            stroke: currentColor;
            stroke-width: 2;
        }

        .icon-fill {
            fill: currentColor;
            stroke: none;
        }

        /* Select & Inputs Header */
        .header-select {
            background: #f1f2f6;
            border: 1px solid transparent;
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            outline: none;
            cursor: pointer;
            max-width: 160px;
            transition: 0.2s;
        }

        .header-select:hover {
            background: #dfe6e9;
            color: #2d3436;
        }

        .header-select option {
            background: white;
            color: #333;
        }

        /* Boutons Actions */
        .btn-action,
        .btn-export,
        .btn-full {
            font-family: inherit;
            font-weight: 600;
            border-radius: var(--radius);
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
            border: none;
        }

        .btn-action:active,
        .btn-export:active {
            transform: translateY(1px);
        }

        .btn-export {
            background-color: var(--accent);
            color: white;
            padding: 8px 18px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(108, 92, 231, 0.3);
        }

        .btn-export:hover {
            background-color: var(--accent-hover);
            box-shadow: 0 4px 8px rgba(108, 92, 231, 0.4);
        }

        .btn-action {
            background-color: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
            padding: 7px 14px;
            font-size: 0.85rem;
        }

        .btn-action:hover {
            background-color: var(--accent-bg);
        }

        .btn-full {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
            box-shadow: 0 2px 5px rgba(108, 92, 231, 0.2);
        }

        .btn-accent:hover {
            background: var(--accent-hover);
        }

        .btn-save {
            background: var(--success);
            color: white;
        }

        .btn-save:hover {
            background-color: #00a884;
        }

        /* --- 3. LAYOUT --- */
        #main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            width: 100%;
        }

        .sidebar {
            width: var(--panel-width);
            background: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 8px 0 10px rgba(0, 0, 0, 0.03);
        }

        #left-sidebar {
            border-right: 1px solid var(--sidebar-border);
            box-shadow: 4px 2px 4px 2px rgba(0, 0, 0, 0.2);
        }

        #right-sidebar {
            border-left: 1px solid var(--sidebar-border);
            width: 280px;
            box-shadow: -4px 2px 4px 2px rgba(0, 0, 0, 0.2);
        }

        .sidebar-content {
            padding: 20px;
        }

        .rs-header {
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid var(--sidebar-border);
            font-weight: 800;
            font-size: 0.9rem;
            color: #2d3436;
            letter-spacing: 0.5px;
        }

        .rs-footer {
            padding: 15px;
            border-top: 1px solid var(--sidebar-border);
            background: #fdfdfd;
            height: 160px;
            display: flex;
            flex-direction: column;
        }

        /* Headers dans la sidebar */
        h3 {
            font-size: 0.8rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 700;
            letter-spacing: 0.8px;
            margin: 25px 0 12px 0;
            display: flex;
            align-items: center;
        }

        h3::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #dfe6e9;
            margin-left: 10px;
        }

        h3.edit-title {
            color: #e67e22;
        }

        h3.edit-title::after {
            background: #ffeaa7;
        }

        /* --- 4. FORMULAIRES --- */
        .control-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: #636e72;
            margin-bottom: 6px;
        }

        input[type="number"],
        select,
        input[type="text"] {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #dfe6e9;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #2d3436;
            transition: 0.2s;
            background: #fff;
        }

        input[type="number"]:focus,
        select:focus,
        input[type="text"]:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        input[type="color"] {
            width: 100%;
            height: 36px;
            padding: 0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            overflow: hidden;
        }

        input[type="range"] {
            width: 100%;
            margin: 5px 0;
            cursor: pointer;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            padding: 4px 0;
            cursor: pointer;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
            cursor: pointer;
            margin: 0;
        }

        .checkbox-wrapper label {
            font-size: 0.9rem;
            cursor: pointer;
            margin: 0;
            user-select: none;
        }

        /* --- 5. LISTES --- */
        .layer-item {
            background: #fff;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border-left-width: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
        }

        .layer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .layer-name-input {
            border: 1px solid transparent;
            border-bottom: 1px solid #ddd;
            font-weight: 600;
            width: 100%;
            padding: 2px;
            background: transparent;
        }

        .obj-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .obj-item {
            border-bottom: 1px solid #f1f2f6;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            transition: background 0.1s;
        }

        .obj-item:hover {
            background: #f8f9fa;
        }

        .obj-item.hidden-item {
            opacity: 0.6;
            background: #fafafa;
            font-style: italic;
        }

        .obj-info {
            flex: 1;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-weight: 500;
            color: #2d3436;
        }

        .obj-actions {
            display: flex;
            gap: 5px;
        }

        .obj-marker {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .obj-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 2px 6px;
            border-radius: 4px;
            color: #b2bec3;
            transition: all 0.2s;
        }

        .obj-btn:hover {
            color: #2d3436;
            background: #dfe6e9;
        }

        .obj-del:hover {
            color: var(--danger);
            background: rgba(214, 48, 49, 0.1);
        }

        .obj-vis:hover {
            color: var(--accent);
        }

        .empty-msg {
            padding: 30px;
            text-align: center;
            color: #b2bec3;
            font-size: 0.9rem;
            font-style: italic;
        }

        /* --- 6. CANVAS & OVERLAYS --- */
        #preview-container {
            flex: 1;
            background: #dfe6e9;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: radial-gradient(#b2bec3 1px, transparent 1px);
            background-size: 20px 20px;
        }

        #canvas-wrapper {
            position: relative;
            background: white;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            transform-origin: center center;
            transition: width 0.3s, height 0.3s;
        }

        /* Handles */
        .resize-handle {
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--accent);
            border: 2px solid white;
            z-index: 20;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .resize-e {
            right: -8px;
            top: 50%;
            margin-top: -6px;
            cursor: ew-resize;
        }

        .resize-s {
            bottom: -8px;
            left: 50%;
            margin-left: -6px;
            cursor: ns-resize;
        }

        .resize-se {
            right: -8px;
            bottom: -8px;
            cursor: nwse-resize;
        }

        #dim-overlay {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(45, 52, 54, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            font-family: monospace;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
        }

        #dim-overlay.visible {
            opacity: 1;
        }

        /* Context Menu */
        #context-menu {
            position: absolute;
            display: none;
            background: white;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 10px;
            width: 200px;
            z-index: 1000;
        }

        #context-menu h4 {
            margin: 0 0 10px 0;
            font-size: 0.9rem;
            color: var(--accent);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        #context-menu .ctx-row {
            margin-bottom: 8px;
        }

        #context-menu button {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: white;
        }

        #context-menu button.danger {
            background: var(--danger);
        }

        #context-menu button.edit {
            background: var(--accent);
            margin-bottom: 5px;
        }

        /* --- 7. MODALS --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 350px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content.large {
            width: 500px;
        }

        .modal-content.xlarge {
            width: 800px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        /* --- 8. TABLEUR VISUEL --- */
        #visualTableContainer {
            display: flex;
            align-items: flex-start;
            gap: 0;
            overflow-x: auto;
            padding: 0;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #dfe6e9;
        }

        .tb-column {
            display: flex;
            flex-direction: column;
            width: 80px;
            flex-shrink: 0;
            border-right: 1px solid #f1f2f6;
            position: relative;
        }

        .tb-column:last-child {
            border-right: none;
        }

        .tb-column.header-col {
            width: 100px;
            background: #f8f9fa;
            border-right: 1px solid #dfe6e9;
        }

        .tb-column.interval {
            width: 50px;
            background: #fff;
        }

        .tb-cell {
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid #f1f2f6;
            font-size: 0.95rem;
            position: relative;
            color: #2d3436;
        }

        .tb-column .tb-cell:last-child {
            border-bottom: none;
        }

        .tb-header-label {
            font-weight: bold;
            color: var(--text-muted);
        }

        .tb-input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            background: transparent;
            font-family: monospace;
            font-size: 1.1rem;
            outline: none;
            color: var(--accent);
            font-weight: 600;
        }

        .tb-input:focus {
            background: var(--accent-bg);
        }

        .tb-btn {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--accent);
        }

        .tb-btn:hover {
            background: var(--accent-bg);
        }

        .btn-add-col {
            width: 50px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .btn-add-col:hover {
            background: #00a884;
        }

        .btn-del-col {
            position: absolute;
            top: -10px;
            right: 50%;
            transform: translateX(50%);
            background: var(--danger);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        .tb-column:hover .btn-del-col {
            display: flex;
        }

        .tb-column.header-col:hover .btn-del-col {
            display: none;
        }

        #floatingInput {
            position: absolute;
            display: none;
            z-index: 5000;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--accent);
            padding: 6px 12px;
            font-family: Arial, sans-serif;
            font-size: 14px;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            min-width: 150px;
            outline: none;
            transform: translate(-50%, -50%);
        }

        .shortcuts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .shortcuts-table td {
            padding: 8px 5px;
            border-bottom: 1px solid #eee;
        }

        .shortcuts-table td:first-child {
            font-family: monospace;
            font-weight: bold;
            color: var(--accent);
            background: #f1f2f6;
            border-radius: 4px;
            padding: 2px 8px;
            display: inline-block;
            margin-bottom: 2px;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d3436;
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-weight: 500;
        }

        .toast.show {
            opacity: 1;
        }

        .visual-marker {
            transition: transform 0.15s ease-out;
        }

        /* Animation Engrenage */
        #btnToggleGridEdit svg {
            transition: transform 0.5s ease;
        }

        #btnToggleGridEdit:hover svg {
            transform: rotate(90deg);
        }

        #btnToggleGridEdit.edit-mode-active svg {
            fill: #e67e22;
            animation: spin 4s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="header-section">
            <div class="app-title">
                <span style="font-size:1.5rem;">üìê</span> Prof Studio
            </div>

            <div class="toolbar-group">
                <button class="tool-btn" onclick="app.undo()" title="Annuler (Ctrl+Z)"><svg viewBox="0 0 24 24"
                        class="icon-fill">
                        <path
                            d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l2.37-.78C21.08 11.03 17.15 8 12.5 8z" />
                    </svg></button>
                <button class="tool-btn" onclick="app.redo()" title="R√©tablir (Ctrl+Y)"><svg viewBox="0 0 24 24"
                        class="icon-fill">
                        <path
                            d="M18.4 10.6C16.55 9 14.15 8 11.5 8c-4.65 0-8.58 3.03-9.96 7.22L3.9 16c1.05-3.19 4.05-5.5 7.6-5.5 1.95 0 3.73.72 5.12 1.88L13 16h9V7l-3.6 3.6z" />
                    </svg></button>
                <div class="divider"></div>
                <select class="header-select" id="headerGridPreset" onchange="app.loadGridPreset(this.value)">
                    <option value="millimeter" selected>Papier Millim√©tr√©</option>
                    <option value="graduated">Rep√®re Gradu√©</option>
                    <option value="seyes">Sey√®s</option>
                    <option value="simple">Carreaux Simples</option>
                </select>
                <div class="divider"></div>
                <button class="tool-btn active" id="btnModeMove" onclick="app.setMode('move')" title="D√©placer (M)"><svg
                        viewBox="0 0 24 24" class="icon-fill">
                        <path
                            d="M10 9h4V6h3l-5-5-5 5h3v3zm-1 1H6V7l-5 5 5 5v-3h3v-4zm14 2l-5-5v3h-3v4h3v3l5-5zm-9 3h-4v3H7l5 5 5-5h-3v-3z" />
                    </svg></button>
                <button class="tool-btn" id="btnModePoint" onclick="app.setMode('point')" title="Point (P)"><svg
                        viewBox="0 0 24 24" class="icon-fill">
                        <path
                            d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z" />
                    </svg></button>
                <button class="tool-btn" id="btnModeLink" onclick="app.setMode('link')" title="Ligne/Segment (L)"><svg
                        viewBox="0 0 24 24" class="icon-fill">
                        <path
                            d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" />
                    </svg></button>
                <button class="tool-btn" id="btnModeCurve" onclick="app.setMode('curve')" title="Courbe Spline (S)"><svg
                        viewBox="0 0 24 24" class="icon-stroke">
                        <circle cx="4" cy="12" r="2" class="icon-fill" />
                        <circle cx="20" cy="12" r="2" class="icon-fill" />
                        <path d="M4 12 C 8 4, 16 20, 20 12" />
                    </svg></button>
                <button class="tool-btn" id="btnModeCircle" onclick="app.setMode('circle')" title="Cercle (C)"><svg
                        viewBox="0 0 24 24" class="icon-stroke">
                        <circle cx="12" cy="12" r="9" />
                        <circle cx="12" cy="12" r="1.5" class="icon-fill" />
                    </svg></button>
                <button class="tool-btn" id="btnModeText" onclick="app.setMode('text')" title="Texte Libre (T)"><svg
                        viewBox="0 0 24 24" class="icon-fill">
                        <path d="M5 4v3h5.5v12h3V7H19V4z" />
                    </svg></button>
                <button class="tool-btn" id="btnModeFunction" onclick="app.setMode('function')"
                    title="Fonction f(x)"><span
                        style="font-size:1.1rem; font-family: 'Times New Roman', serif; font-weight:bold; font-style:italic;">f(x)</span></button>
                <button class="tool-btn" id="btnModeTable" onclick="app.openTableModal()"
                    title="Tableau de Variation"><svg viewBox="0 0 24 24" class="icon-fill">
                        <path d="M4 4h16v16H4V4zm2 2v2h12V6H6zm0 4v8h4v-8H6zm6 0v8h6v-8h-6z" />
                    </svg></button>
                <div class="divider"></div>
                <button class="tool-btn active" id="btnToggleAxes" onclick="app.toggleAxes()" title="Axes"><svg
                        viewBox="0 0 24 24" class="icon-stroke">
                        <path d="M12 3v18 M3 12h18 M12 3l-3 3 M12 3l3 3 M21 12l-3-3 M21 12l-3 3" />
                    </svg></button>
                <button class="tool-btn active" id="btnToggleMagnet" onclick="app.toggleMagnet()" title="Aimant">
                    <svg viewBox="0 0 24 24" class="icon-fill">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M1.25 12C1.25 6.61522 5.61522 2.25 11 2.25H16.5C17.7426 2.25 18.75 3.25736 18.75 4.5V6C18.75 7.24264 17.7426 8.25 16.5 8.25H10.9444C8.87338 8.25 7.19444 9.92893 7.19444 12C7.19444 14.0711 8.87338 15.75 10.9444 15.75H16.5C17.7426 15.75 18.75 16.7574 18.75 18V19.5C18.75 20.7426 17.7426 21.75 16.5 21.75H11C5.61522 21.75 1.25 17.3848 1.25 12ZM11 3.75C6.44365 3.75 2.75 7.44365 2.75 12C2.75 16.5563 6.44365 20.25 11 20.25H13.6944V17.25H10.9444C8.04495 17.25 5.69444 14.8995 5.69444 12C5.69444 9.1005 8.04495 6.75 10.9444 6.75H13.6944V3.75H11ZM15.1944 3.75V6.75H16.5C16.9142 6.75 17.25 6.41421 17.25 6V4.5C17.25 4.08579 16.9142 3.75 16.5 3.75H15.1944ZM15.1944 17.25V20.25H16.5C16.9142 20.25 17.25 19.9142 17.25 19.5V18C17.25 17.5858 16.9142 17.25 16.5 17.25H15.1944Z"
                            fill="currentColor" />
                        <path
                            d="M21.0199 5.42382C21.3381 5.15865 21.811 5.20164 22.0762 5.51985L21.5 5.99999C22.0762 5.51985 22.0759 5.51951 22.0762 5.51985L22.0773 5.52123L22.0786 5.52277L22.0816 5.52638L22.0891 5.53565C22.0948 5.54275 22.1018 5.55168 22.1102 5.56247C22.1269 5.58404 22.1486 5.61304 22.1748 5.64961C22.227 5.72274 22.2966 5.82614 22.3775 5.96099C22.5394 6.23081 22.7463 6.62597 22.95 7.15575C23.3582 8.21712 23.75 9.80842 23.75 12C23.75 14.1916 23.3582 15.7829 22.95 16.8442C22.7463 17.374 22.5394 17.7692 22.3775 18.039C22.2966 18.1738 22.227 18.2772 22.1748 18.3504C22.1486 18.3869 22.1269 18.4159 22.1102 18.4375C22.1018 18.4483 22.0948 18.4572 22.0891 18.4643L22.0816 18.4736L22.0786 18.4772L22.0773 18.4788C22.077 18.4791 22.0762 18.4801 21.5 18L22.0762 18.4801C21.811 18.7983 21.3381 18.8413 21.0199 18.5762C20.7032 18.3123 20.6591 17.8426 20.92 17.5244L20.9235 17.52L20.9339 17.5063C20.9393 17.4991 20.9461 17.4898 20.9542 17.4785C20.9839 17.4368 21.0315 17.3668 21.0913 17.2672C21.2106 17.0683 21.3788 16.751 21.55 16.3058C21.8918 15.4171 22.25 14.0084 22.25 12C22.25 9.99156 21.8918 8.58285 21.55 7.69422C21.3788 7.249 21.2106 6.93167 21.0913 6.73274C21.0315 6.63321 20.9839 6.56317 20.9542 6.52146C20.9393 6.50061 20.9288 6.48683 20.9235 6.47999L20.92 6.47552L21.0199 5.42382Z"
                            fill="currentColor" />
                        <path
                            d="M20.1556 8.63578C19.9545 8.27369 19.4979 8.14324 19.1358 8.3444C18.7768 8.54385 18.6455 8.99442 18.8393 9.355L18.8443 9.36524C18.8512 9.37963 18.8643 9.40835 18.8818 9.45199C18.9167 9.53921 18.9691 9.68652 19.0235 9.8988C19.1322 10.3229 19.25 11.0101 19.25 12C19.25 12.9899 19.1322 13.6772 19.0235 14.1012C18.9691 14.3135 18.9167 14.4608 18.8818 14.548C18.8643 14.5917 18.8512 14.6204 18.8443 14.6348L18.8393 14.645C18.6455 15.0056 18.7768 15.4562 19.1358 15.6556C19.4979 15.8568 19.9545 15.7263 20.1556 15.3642L20.1563 15.3629L20.1571 15.3615L20.1588 15.3585L20.1626 15.3514L20.1723 15.333C20.1795 15.319 20.1884 15.3012 20.1986 15.2797C20.2191 15.2367 20.2451 15.1787 20.2745 15.1051C20.3333 14.958 20.4059 14.749 20.4765 14.4738C20.6178 13.9229 20.75 13.1101 20.75 12C20.75 10.8899 20.6178 10.0772 20.4765 9.52623C20.4059 9.25101 20.3333 9.04207 20.2745 8.89491C20.2451 8.82136 20.2191 8.76336 20.1986 8.72034C20.1884 8.69883 20.1795 8.68107 20.1723 8.667L20.1626 8.64865L20.1588 8.64154L20.1571 8.63849L20.1563 8.63709L20.1556 8.63578Z"
                            fill="currentColor" />
                    </svg>
                </button>
            </div>
        </div>
        <div class="header-section">
            <button class="tool-btn" onclick="app.openHelpModal()" title="Aide / Tutoriel" style="color:#fdcb6e;"><svg
                    viewBox="0 0 24 24" class="icon-fill">
                    <path
                        d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
                </svg></button>
            <button class="btn-action" onclick="app.saveProject()">Sauvegarder</button>
            <button class="btn-action" onclick="app.triggerLoad()">Ouvrir</button>
            <input type="file" id="fileLoader" style="display:none" onchange="app.handleFileLoad(this)">

            <button class="tool-btn" id="btnToggleGridEdit" onclick="app.toggleGridEditMode()"
                title="Param√®tres Grille">
                <svg viewBox="0 0 24 24" class="icon-fill">
                    <path
                        d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.49l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
                </svg>
            </button>

            <button class="btn-export" onclick="app.openExportModal()">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="white">
                    <path
                        d="M19 12v7H5v-7H3v7c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2zm-6 .67l2.59-2.58L17 11.5l-5 5-5-5 1.41-1.41L11 12.67V3h2v9.67z" />
                </svg>
                Exporter
            </button>
        </div>
    </header>

    <div id="main-container">
        <div id="left-sidebar" class="sidebar">
            <div class="sidebar-content">
                <div id="normal-mode-panel">
                    <div id="function-settings-panel"
                        style="display:none; background:#e8f5e9; padding:12px; border:1px solid #a5d6a7; border-radius:8px; margin-bottom:15px;">
                        <label style="color:#2e7d32;">Tracer une Fonction</label>
                        <div class="input-group"><label>f(x) = </label><input type="text" id="funcInput"
                                placeholder="ex: 0.5*x^2 - 2" style="font-family:monospace; font-size:1rem;"></div>
                        <div class="control-row">
                            <div class="input-group"><label>Couleur</label><input type="color" id="funcColor"
                                    value="#e74c3c"></div>
                            <div class="input-group"><label>√âpaisseur</label><input type="number" id="funcWidth"
                                    value="2"></div>
                        </div>
                        <button class="btn-full btn-accent" onclick="app.addFunction()">Tracer</button>
                    </div>
                    <div id="tool-settings-panel">
                        <div class="input-group">
                            <label style="color:#1565c0;">Style de Trait / Courbe</label>
                            <div class="control-row">
                                <select id="linkType">
                                    <option value="segment">Segment</option>
                                    <option value="vector">Vecteur</option>
                                </select>
                                <input type="color" id="linkColor" value="#27ae60">
                            </div>
                        </div>
                        <div class="control-row">
                            <div class="input-group"><label>√âpaisseur</label><input type="number" id="linkWidth"
                                    value="2"></div>
                            <div class="checkbox-wrapper" style="align-items:flex-end; padding-bottom:5px;"><input
                                    type="checkbox" id="linkDashed"><label for="linkDashed">Pointill√©s</label></div>
                        </div>
                    </div>
                    <h3>Mise en page</h3>
                    <div class="control-row">
                        <div class="input-group"><label>Format</label><select id="sizePreset"
                                onchange="app.applySizePreset()">
                                <option value="custom">Custom</option>
                                <option value="a4_p">A4 Port.</option>
                                <option value="a4_l">A4 Pays.</option>
                                <option value="sq_10" selected>Carr√© 10</option>
                                <option value="sq_20">Carr√© 20</option>
                            </select></div>
                        <div class="input-group"><label>Marge</label><input type="number" id="margin" value="20"
                                oninput="app.updateRender()"></div>
                    </div>
                    <div class="control-row">
                        <div class="input-group"><label>L (px)</label><input type="number" id="totalWidth"></div>
                        <div class="input-group"><label>H (px)</label><input type="number" id="totalHeight"></div>
                    </div>
                    <h3>Axes & Grille</h3>
                    <div class="input-group">
                        <label>Th√®me Couleur</label>
                        <select id="themeSelector" onchange="app.applyTheme(this.value)">
                            <option value="default">Standard</option>
                            <option value="grayscale">Niveaux de Gris</option>
                            <option value="blueprint">Bleu Architecte</option>
                            <option value="warm">Chaud</option>
                            <option value="green">Nature</option>
                            <option value="contrast">Contraste Fort</option>
                        </select>
                    </div>
                    <div
                        style="background:#fff; border:1px solid #dfe6e9; padding:12px; border-radius:8px; margin-top:10px;">
                        <div class="control-row">
                            <div class="checkbox-wrapper"><input type="checkbox" id="showTicks" checked
                                    onchange="app.updateRender()"><label for="showTicks">Ticks</label></div>
                            <div class="checkbox-wrapper"><input type="checkbox" id="showLabels"
                                    onchange="app.updateRender()"><label for="showLabels">Nombres</label></div>
                        </div>
                        <div style="margin-top:8px;">
                            <label>Police</label>
                            <div style="display:grid; grid-template-columns:2fr 1fr; gap:8px;"><select id="fontFamily"
                                    onchange="app.updateRender()">
                                    <option value="Arial">Arial</option>
                                    <option value="Times New Roman">Times</option>
                                    <option value="Comic Sans MS">Comic</option>
                                </select><input type="number" id="fontSize" value="12" oninput="app.updateRender()">
                            </div>
                        </div>
                        <div style="margin-top:8px;">
                            <label>Style Label</label>
                            <select id="labelStyle" onchange="app.updateRender()">
                                <option value="badge" selected>Badge (Fond Blanc)</option>
                                <option value="simple">Simple (Transparent)</option>
                            </select>
                        </div>
                        <div style="margin-top:8px;">
                            <label>Espacement Nombres</label>
                            <input type="range" id="labelDist" min="10" max="60" value="20"
                                oninput="app.updateLabelDist(this.value)">
                        </div>
                    </div>
                </div>
                <div id="grid-edit-panel" style="display:none;">
                    <h3 class="edit-title">√âdition des Couches</h3>
                    <div id="layers-container-edit"></div>
                    <button class="btn-full btn-accent" onclick="app.addLayer()">+ Ajouter une couche</button>
                    <h3 class="edit-title" style="margin-top:30px;">Sauvegarder Preset</h3>
                    <div class="input-group"><label>Nom du nouveau papier</label><input type="text" id="newPresetName"
                            placeholder="Mon Papier Perso"></div>
                    <button class="btn-full btn-save" onclick="app.saveCustomPreset()">Enregistrer dans la
                        liste</button>
                </div>
            </div>
        </div>

        <div id="preview-container">
            <div id="canvas-wrapper">
                <div class="resize-handle resize-e" data-dir="e"></div>
                <div class="resize-handle resize-s" data-dir="s"></div>
                <div class="resize-handle resize-se" data-dir="se"></div>
            </div>
            <div id="dim-overlay">0 x 0 mm</div>
            <input type="text" id="floatingInput" placeholder="Entrez le texte..." />
            <div id="context-menu">
                <h4 id="ctxTitle">Modifier</h4>
                <div class="ctx-row" id="ctxNameRow">
                    <div class="input-group"><label>Nom</label><input type="text" id="ctxName"></div>
                </div>
                <div class="ctx-row" id="ctxColorRow">
                    <div class="input-group"><label>Couleur</label><input type="color" id="ctxColor"></div>
                </div>
                <div class="ctx-row" id="ctxShowCoordsRow">
                    <div class="checkbox-wrapper"><input type="checkbox" id="ctxShowCoords"><label
                            for="ctxShowCoords">Coordonn√©es</label></div>
                </div>
                <button class="edit" id="ctxEditBtn" style="display:none;" onclick="app.editActiveTable()">Modifier le
                    tableau</button>
                <button class="danger" id="ctxDeleteBtn">Supprimer</button>
            </div>
        </div>

        <div id="right-sidebar" class="sidebar">
            <div class="rs-header">Liste des Objets</div>
            <div class="rs-content" style="flex:1; overflow-y:auto;">
                <div style="padding:10px;">
                    <strong
                        style="font-size:0.75rem; color:#b2bec3; text-transform:uppercase; border-bottom:1px solid #f1f2f6; display:block; margin-bottom:8px;">Tableaux</strong>
                    <div id="tablesListContainer"></div>
                    <strong
                        style="font-size:0.75rem; color:#b2bec3; text-transform:uppercase; border-bottom:1px solid #f1f2f6; display:block; margin-bottom:8px; margin-top:20px;">Points</strong>
                    <div id="pointsListContainer"></div>
                    <strong
                        style="font-size:0.75rem; color:#b2bec3; text-transform:uppercase; display:block; margin-top:20px; border-bottom:1px solid #f1f2f6; margin-bottom:8px;">G√©om√©trie</strong>
                    <div id="linksListContainer"></div>
                    <strong
                        style="font-size:0.75rem; color:#b2bec3; text-transform:uppercase; display:block; margin-top:20px; border-bottom:1px solid #f1f2f6; margin-bottom:8px;">Textes</strong>
                    <div id="textsListContainer"></div>
                    <strong
                        style="font-size:0.75rem; color:#b2bec3; text-transform:uppercase; display:block; margin-top:20px; border-bottom:1px solid #f1f2f6; margin-bottom:8px;">Fonctions</strong>
                    <div id="funcsListContainer"></div>
                </div>
            </div>
            <div class="rs-footer">
                <label style="font-weight:bold; color:#636e72; font-size:0.8rem; margin-bottom:8px;">Bilan /
                    √ânonc√©</label>
                <textarea id="summaryText"
                    style="flex:1; width:100%; resize:none; border:1px solid #dfe6e9; border-radius:6px; padding:10px; font-size:0.85rem; font-family:monospace;"
                    readonly></textarea>
            </div>
        </div>
    </div>

    <div id="table-modal" class="modal">
        <div class="modal-content xlarge">
            <div
                style="font-size:1.2rem; font-weight:800; margin-bottom:20px; border-bottom:1px solid #f1f2f6; padding-bottom:10px; color:#2d3436;">
                Cr√©er un Tableau de Variation</div>
            <p style="font-size:0.95rem; color:#636e72; margin-bottom:20px;">Cliquez sur les cases pour changer les
                signes/fl√®ches. Utilisez le bouton vert pour ajouter des colonnes.</p>
            <div style="margin-bottom:20px;">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="showFPrime" checked onchange="app.toggleTableRows()">
                    <label for="showFPrime" style="font-weight:600;">Afficher la ligne f'(x)</label>
                </div>
            </div>
            <div style="display:flex;">
                <div class="tb-column header-col">
                    <div class="tb-cell tb-header-label">x</div>
                    <div class="tb-cell tb-header-label" id="tbHeaderPrime">f'(x)</div>
                    <div class="tb-cell tb-header-label">f(x)</div>
                </div>
                <div id="visualTableContainer"></div>
                <button class="btn-add-col" onclick="app.addTableColumn()" title="Ajouter une colonne">+</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" style="background:#f1f2f6; color:#636e72;"
                    onclick="document.getElementById('table-modal').style.display='none'">Annuler</button>
                <button class="modal-btn" style="background:var(--success); color:white;"
                    onclick="app.confirmTable()">Valider</button>
            </div>
        </div>
    </div>

    <div id="export-modal" class="modal">
        <div class="modal-content">
            <div
                style="font-size:1.2rem; font-weight:800; margin-bottom:20px; border-bottom:1px solid #f1f2f6; padding-bottom:10px; color:#2d3436;">
                Exporter</div>
            <div class="input-group">
                <label>Format</label>
                <select id="exportFormat">
                    <option value="png" selected>Image (PNG)</option>
                    <option value="svg">Vecteur (SVG)</option>
                    <option value="tikz">Code LaTeX (TikZ)</option>
                </select>
            </div>
            <div class="input-group" id="qualityControl">
                <label>Qualit√©</label>
                <select id="exportQuality">
                    <option value="1">1x (√âcran)</option>
                    <option value="2" selected>2x (Impression)</option>
                    <option value="4">4x (Ultra HD)</option>
                </select>
            </div>
            <div class="modal-actions">
                <button class="modal-btn" style="background:#f1f2f6; color:#636e72;"
                    onclick="document.getElementById('export-modal').style.display='none'">Annuler</button>
                <button class="modal-btn" style="background:var(--accent); color:white;"
                    onclick="app.performExport('download')">T√©l√©charger</button>
                <button class="modal-btn" id="btnCopy" style="background:var(--success); color:white;"
                    onclick="app.performExport('copy')">Presse Papier</button>
            </div>
        </div>
    </div>

    <div id="help-modal" class="modal">
        <div class="modal-content large">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid #f1f2f6; padding-bottom:10px;">
                <div style="font-size:1.2rem; font-weight:800;">Aide & Raccourcis</div>
                <button onclick="document.getElementById('help-modal').style.display='none'"
                    style="border:none; background:none; cursor:pointer; font-size:1.5rem; color:#b2bec3;">√ó</button>
            </div>
            <p style="font-size:0.95rem; margin-bottom:20px; color:#636e72;">Bienvenue dans <strong>Prof
                    Studio</strong>. Utilisez la barre d'outils ou les raccourcis clavier pour dessiner.</p>
            <table class="shortcuts-table">
                <tr>
                    <td>Ctrl + Z / Y</td>
                    <td>Annuler / R√©tablir</td>
                </tr>
                <tr>
                    <td>M</td>
                    <td>Outil D√©placement</td>
                </tr>
                <tr>
                    <td>P</td>
                    <td>Placer un Point</td>
                </tr>
                <tr>
                    <td>L</td>
                    <td>Ligne / Segment</td>
                </tr>
                <tr>
                    <td>S</td>
                    <td>Courbe Spline</td>
                </tr>
                <tr>
                    <td>C</td>
                    <td>Cercle</td>
                </tr>
                <tr>
                    <td>T</td>
                    <td>Texte Libre</td>
                </tr>
                <tr>
                    <td>Clic Droit</td>
                    <td>Modifier un objet (Tableau inclus)</td>
                </tr>
                <tr>
                    <td>Suppr</td>
                    <td>Supprimer s√©lection</td>
                </tr>
            </table>
        </div>
    </div>

    <div id="toast" class="toast">Op√©ration effectu√©e</div>
    <script>
        const app = {
            state: {
                width: 0, height: 0, baseUnit: 40, margin: 20,
                axisX: 0, axisY: 0,
                layers: [], points: [], links: [], curves: [], functions: [], circles: [], texts: [],
                tables: [], tableDraft: [],
                activeCurve: [],
                history: [], redoStack: [],
                interactionMode: 'move', tempLinkStart: null,
                showAxes: true, showLabels: false, showTicks: true,
                labelStyle: 'badge', labelDistance: 20, labelFont: "Arial", labelFontSize: 12,
                magnetMode: true, activeContext: null, viewZoom: 1.0, isGridEditMode: false,
                tempTextPos: null, isEditingTable: false, editingTableIndex: -1
            },

            lineStyles: { solid: "none", dash: "8, 6", shortdash: "4, 4", dot: "1, 5" },

            presets: {
                grid: {
                    millimeter: [{ name: "1mm", m: 0.1, c: "#e0e0e0", w: 0.25, s: "solid", dir: "both" }, { name: "5mm", m: 0.5, c: "#bdc3c7", w: 0.5, s: "solid", dir: "both" }, { name: "1cm", m: 1, c: "#f39c12", w: 1, s: "solid", dir: "both" }],
                    graduated: [{ name: "0.5 cm", m: 0.5, c: "#bdc3c7", w: 0.5, s: "solid", dir: "both" }, { name: "1 cm", m: 1, c: "#7f8c8d", w: 1, s: "solid", dir: "both" }],
                    seyes: [{ name: "Lignes", m: 1, c: "#5b2c6f", w: 1, s: "solid", dir: "both" }, { name: "Interlignes", m: 0.25, c: "#aed6f1", w: 0.3, s: "solid", dir: "h" }],
                    simple: [{ name: "Carreau", m: 1, c: "#aaa", w: 0.5, s: "solid", dir: "both" }]
                },
                sizes: { a4_p: { w: 794, h: 1123 }, a4_l: { w: 1123, h: 794 }, sq_10: { w: 378, h: 378 }, sq_20: { w: 756, h: 756 } },
                themes: {
                    default: { graduated: ["#bdc3c7", "#7f8c8d"], millimeter: ["#e0e0e0", "#bdc3c7", "#f39c12"], seyes: ["#5b2c6f", "#aed6f1"], simple: ["#aaaaaa"] },
                    grayscale: { graduated: ["#d0d0d0", "#888"], millimeter: ["#f0f0f0", "#d0d0d0", "#707070"], seyes: ["#555555", "#cccccc"], simple: ["#999999"] },
                    blueprint: { graduated: ["#90caf9", "#1565c0"], millimeter: ["#e3f2fd", "#90caf9", "#1565c0"], seyes: ["#0d47a1", "#bbdefb"], simple: ["#1976d2"] },
                    warm: { graduated: ["#ffccbc", "#e64a19"], millimeter: ["#fbe9e7", "#ffab91", "#d84315"], seyes: ["#bf360c", "#ffccbc"], simple: ["#ff7043"] },
                    green: { graduated: ["#c8e6c9", "#388e3c"], millimeter: ["#e8f5e9", "#a5d6a7", "#2e7d32"], seyes: ["#1b5e20", "#c8e6c9"], simple: ["#66bb6a"] },
                    contrast: { graduated: ["#888888", "#000000"], millimeter: ["#cccccc", "#999999", "#000000"], seyes: ["#000000", "#999999"], simple: ["#000000"] }
                }
            },

            ui: {
                wrapper: document.getElementById('canvas-wrapper'),
                overlay: document.getElementById('dim-overlay'),
                ctxMenu: document.getElementById('context-menu'),
                pointsList: document.getElementById('pointsListContainer'),
                linksList: document.getElementById('linksListContainer'),
                funcsList: document.getElementById('funcsListContainer'),
                textsList: document.getElementById('textsListContainer'),
                tablesList: document.getElementById('tablesListContainer'),
                summary: document.getElementById('summaryText'),
                inputs: { w: document.getElementById('totalWidth'), h: document.getElementById('totalHeight') },
                floatingInput: document.getElementById('floatingInput'),
                visualTable: document.getElementById('visualTableContainer')
            },

            init: function () {
                const presetVal = document.getElementById('headerGridPreset').value;
                this.loadGridPreset(presetVal);
                this.applySizePreset();

                ['totalWidth', 'totalHeight', 'margin', 'labelDist', 'fontSize'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', (e) => {
                        this.saveState();
                        if (app.state[id]) app.state[id] = parseInt(e.target.value);
                        else if (id === 'totalWidth') app.setSize(parseInt(e.target.value), app.state.height);
                        else if (id === 'totalHeight') app.setSize(app.state.width, parseInt(e.target.value));
                        else app.updateRender();
                    });
                });

                document.querySelectorAll('.resize-handle').forEach(h => {
                    h.addEventListener('mousedown', (e) => this.startResize(e, h.dataset.dir));
                });

                this.ui.wrapper.addEventListener('mousedown', (e) => {
                    if (e.button === 2) return;
                    if (e.target.classList.contains('resize-handle')) return;
                    if (e.target === this.ui.floatingInput) return;
                    if (this.ui.floatingInput.style.display === 'block') { this.confirmText(); return; }

                    if (this.state.interactionMode === 'move') this.startAxesDrag(e);
                    else if (this.state.interactionMode === 'point') this.addPoint(e);
                    else if (this.state.interactionMode === 'text') this.addText(e);
                    else if (this.state.interactionMode === 'link' || this.state.interactionMode === 'circle' || this.state.interactionMode === 'curve') {
                        const isPointClick = e.target.tagName === 'circle' && e.target.parentElement.classList.contains('visual-marker') === false;
                        if (!isPointClick) { const newPointIndex = this.addPoint(e); this.handlePointClick(e, newPointIndex); }
                    }
                });

                this.ui.wrapper.addEventListener('wheel', (e) => {
                    if (e.ctrlKey || !e.ctrlKey) { e.preventDefault(); const delta = e.deltaY > 0 ? -0.1 : 0.1; this.zoomView(delta); }
                }, { passive: false });

                window.addEventListener('mousemove', (e) => this.onMouseMove(e));
                window.addEventListener('mouseup', (e) => this.onMouseUp(e));
                window.addEventListener('click', (e) => this.hideCtxMenu());

                this.ui.floatingInput.addEventListener('keydown', (e) => {
                    e.stopPropagation(); if (e.key === 'Enter') this.confirmText(); if (e.key === 'Escape') this.cancelText();
                });

                window.addEventListener('keydown', (e) => {
                    if (document.querySelector('.modal').style.display === 'flex' && e.key !== 'Escape') return;
                    if (this.ui.floatingInput.style.display === 'block') return;
                    if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); this.undo(); return; }
                    if ((e.ctrlKey || e.metaKey) && e.key === 'y') { e.preventDefault(); this.redo(); return; }
                    if (e.key === "Escape") { if (this.state.activeCurve.length > 1) this.finishCurve(); else { this.state.tempLinkStart = null; this.setMode('move'); document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); this.hideCtxMenu(); } }
                    if (e.key === "Enter" && this.state.interactionMode === 'curve') this.finishCurve();
                    if (e.key === 'Delete' || e.key === 'Backspace') { if (this.state.activeContext) this.deleteActiveItem(); }
                    if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                        switch (e.key.toLowerCase()) {
                            case 'm': this.setMode('move'); break; case 'p': this.setMode('point'); break; case 'l': this.setMode('link'); break; case 's': this.setMode('curve'); break; case 'c': this.setMode('circle'); break; case 't': this.setMode('text'); break;
                        }
                    }
                });

                document.getElementById('ctxName').addEventListener('input', (e) => { this.saveState(); this.updateFromCtx('label', e.target.value); });
                document.getElementById('ctxColor').addEventListener('input', (e) => { this.saveState(); this.updateFromCtx('color', e.target.value); });
                document.getElementById('ctxShowCoords').addEventListener('change', (e) => { this.saveState(); this.updateFromCtx('showCoords', e.target.checked); });
                document.getElementById('ctxDeleteBtn').addEventListener('click', () => { this.saveState(); this.deleteActiveItem(); });

                document.getElementById('exportFormat').addEventListener('change', (e) => {
                    const isPng = e.target.value === 'png';
                    document.getElementById('qualityControl').style.display = isPng ? 'block' : 'none';
                    document.getElementById('btnCopy').style.display = isPng ? 'inline-block' : 'none';
                });
            },

            // --- UNDO / REDO ---
            saveState: function () {
                if (this.state.history.length > 50) this.state.history.shift();
                const stateClone = JSON.parse(JSON.stringify(this.state));
                delete stateClone.history; delete stateClone.redoStack;
                this.state.history.push(stateClone); this.state.redoStack = [];
            },
            undo: function () {
                if (this.state.history.length === 0) return;
                const currentState = JSON.parse(JSON.stringify(this.state));
                delete currentState.history; delete currentState.redoStack;
                this.state.redoStack.push(currentState);
                const prevState = this.state.history.pop();
                this.restoreState(prevState);
            },
            redo: function () {
                if (this.state.redoStack.length === 0) return;
                const currentState = JSON.parse(JSON.stringify(this.state));
                delete currentState.history; delete currentState.redoStack;
                this.state.history.push(currentState);
                const nextState = this.state.redoStack.pop();
                this.restoreState(nextState);
            },
            restoreState: function (stateData) {
                Object.keys(stateData).forEach(k => { this.state[k] = stateData[k]; });
                this.syncUI();
                document.getElementById('headerGridPreset').value = (this.presets.grid[this.state.layers[0]?.name]) ? this.state.layers[0].name : "simple";
                this.updateRender();
            },

            // --- SAVE / LOAD PROJECT ---
            saveProject: function () {
                const data = JSON.stringify(this.state);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'projet_prof_studio.json';
                a.click();
                URL.revokeObjectURL(url);
            },
            triggerLoad: function () {
                document.getElementById('fileLoader').click();
            },
            handleFileLoad: function (input) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const newState = JSON.parse(e.target.result);
                        this.restoreState(newState);
                        this.state.history = []; // Clear history after load
                        this.state.redoStack = [];
                        this.showToast("Projet charg√© !");
                    } catch (err) {
                        alert("Erreur lors du chargement du fichier.");
                    }
                };
                reader.readAsText(file);
                input.value = ''; // Reset input
            },

            // --- MAIN LOGIC ---
            toggleAxes: function () {
                // On inverse l'√©tat (vrai/faux)
                this.state.showAxes = !this.state.showAxes;

                // CORRECTION : On v√©rifie si la checkbox existe avant de la toucher
                const chkBox = document.getElementById('showAxes');
                if (chkBox) {
                    chkBox.checked = this.state.showAxes;
                }

                // Mise √† jour du bouton de la barre d'outils (qui lui existe toujours)
                const btn = document.getElementById('btnToggleAxes');
                if (btn) {
                    btn.classList.toggle('active', this.state.showAxes);
                }

                // On redessine le canvas
                this.updateRender();
            },
            toggleMagnet: function () { this.state.magnetMode = !this.state.magnetMode; document.getElementById('btnToggleMagnet').classList.toggle('active', this.state.magnetMode); },
            toggleGridEditMode: function () {
                this.state.isGridEditMode = !this.state.isGridEditMode;
                document.getElementById('btnToggleGridEdit').classList.toggle('edit-mode-active', this.state.isGridEditMode);
                document.getElementById('normal-mode-panel').style.display = this.state.isGridEditMode ? 'none' : 'block';
                document.getElementById('grid-edit-panel').style.display = this.state.isGridEditMode ? 'block' : 'none';
                this.generateLayerUI();
            },

            // --- GESTION GRILLES ---
            loadGridPreset: function (val) {
                this.saveState();
                if (!val) val = document.getElementById('headerGridPreset').value;
                let preset;
                if (this.presets.grid[val]) { preset = JSON.parse(JSON.stringify(this.presets.grid[val])); } else { preset = JSON.parse(JSON.stringify(this.presets.grid['simple'])); }
                preset.forEach(l => { if (!l.s) l.s = "solid"; if (!l.dir) l.dir = "both"; });
                this.state.layers = preset;
                this.applyTheme(document.getElementById('themeSelector').value);
            },
            addLayer: function () {
                this.saveState();
                this.state.layers.push({ name: "Nouvelle Couche", m: 1, c: "#999999", w: 0.5, s: "solid", dir: "both" });
                this.generateLayerUI(); this.updateRender();
            },
            removeLayer: function (index) {
                this.saveState();
                if (this.state.layers.length <= 1) { alert("Impossible de supprimer la derni√®re couche."); return; }
                this.state.layers.splice(index, 1);
                this.generateLayerUI(); this.updateRender();
            },
            saveCustomPreset: function () {
                const name = document.getElementById('newPresetName').value.trim();
                if (!name) { alert("Veuillez donner un nom."); return; }
                const id = "custom_" + Date.now();
                this.presets.grid[id] = JSON.parse(JSON.stringify(this.state.layers));
                const select = document.getElementById('headerGridPreset');
                const opt = document.createElement('option');
                opt.value = id; opt.text = name;
                select.add(opt); select.value = id;
                this.toggleGridEditMode();
                alert("Grille sauvegard√©e !");
            },
            applyTheme: function (themeName) {
                const type = document.getElementById('headerGridPreset').value;
                let preset;
                if (this.presets.grid[type]) { preset = this.presets.themes[themeName][type] || this.presets.themes[themeName]['simple']; } else { preset = this.presets.themes[themeName]['simple']; }
                this.state.layers.forEach((layer, index) => { if (preset && preset.length) layer.c = preset[index % preset.length]; });
                this.generateLayerUI();
                this.updateRender();
            },
            updateLayerConfig: function (index, prop, value) { this.saveState(); this.state.layers[index][prop] = value; this.updateRender(); },
            updateLayerDir: function (index, dir) { this.saveState(); this.state.layers[index]['dir'] = dir; this.updateRender(); },
            generateLayerUI: function () {
                const isEdit = this.state.isGridEditMode;
                const containerId = isEdit ? 'layers-container-edit' : 'layers-container-normal';
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                this.state.layers.forEach((layer, index) => {
                    const div = document.createElement('div'); div.className = 'layer-item'; div.style.borderLeftColor = layer.c;
                    let headerHtml = isEdit ? `<div class="layer-header" style="gap:5px;"><input type="text" class="layer-name-input" value="${layer.name}" oninput="app.updateLayerConfig(${index}, 'name', this.value)"><button class="obj-del" style="color:var(--danger);" onclick="app.removeLayer(${index})" title="Supprimer">üóëÔ∏è</button></div>` : `<div class="layer-header"><span>${layer.name}</span></div>`;
                    let extraEditHtml = isEdit ? `<div class="input-group"><label>R√©p√©tition (u)</label><input type="number" step="0.1" value="${layer.m}" oninput="app.updateLayerConfig(${index}, 'm', parseFloat(this.value))"></div>` : '';
                    div.innerHTML = headerHtml + `<div class="control-row"><div class="input-group"><label>Couleur</label><input type="color" value="${layer.c}" oninput="app.updateLayerConfig(${index}, 'c', this.value)"></div><div class="input-group"><label>√âpaisseur</label><input type="number" value="${layer.w}" step="0.1" oninput="app.updateLayerConfig(${index}, 'w', parseFloat(this.value))"></div></div>${extraEditHtml}<div class="control-row"><select onchange="app.updateLayerConfig(${index}, 's', this.value)" style="font-size:0.8rem; padding:4px;"><option value="solid" ${layer.s === 'solid' ? 'selected' : ''}>Continu</option><option value="dash" ${layer.s === 'dash' ? 'selected' : ''}>Tirets</option><option value="shortdash" ${layer.s === 'shortdash' ? 'selected' : ''}>Courts</option><option value="dot" ${layer.s === 'dot' ? 'selected' : ''}>Points</option></select><select onchange="app.updateLayerDir(${index}, this.value)" style="font-size:0.8rem; padding:4px;"><option value="both" ${(!layer.dir || layer.dir === 'both') ? 'selected' : ''}>Quadrillage (XY)</option><option value="h" ${layer.dir === 'h' ? 'selected' : ''}>Horizontal (H)</option><option value="v" ${layer.dir === 'v' ? 'selected' : ''}>Vertical (V)</option></select></div>`;
                    container.appendChild(div);
                });
            },

            // --- NOUVEAU: TABLEAU DE VARIATION VISUEL ---
            openTableModal: function () {
                // Initialize draft if empty
                if (!this.state.tableDraft || this.state.tableDraft.length === 0) {
                    this.state.tableDraft = [
                        { type: 'val', x: '-inf', sign: '0', var: '' },
                        { type: 'int', sign: '+', arr: 'up' },
                        { type: 'val', x: '+inf', sign: '0', var: '' }
                    ];
                }
                document.getElementById('showFPrime').checked = true;
                this.renderTableDraft();
                document.getElementById('table-modal').style.display = 'flex';
            },

            // --- √âDITER UN TABLEAU EXISTANT ---
            editActiveTable: function () {
                if (!this.state.activeContext || this.state.activeContext.type !== 'table') return;

                const idx = this.state.activeContext.index;
                const t = this.state.tables[idx];

                this.state.isEditingTable = true;
                this.state.editingTableIndex = idx;

                // Reconstruire le "draft" √† partir des donn√©es du tableau
                this.state.tableDraft = JSON.parse(JSON.stringify(t.draftData)); // On utilise la copie sauvegard√©e
                document.getElementById('showFPrime').checked = t.showFPrime;

                this.renderTableDraft();
                document.getElementById('table-modal').style.display = 'flex';
                this.hideCtxMenu();
            },

            toggleTableRows: function () {
                this.renderTableDraft();
            },

            renderTableDraft: function () {
                const c = this.ui.visualTable;
                c.innerHTML = '';
                const showPrime = document.getElementById('showFPrime').checked;

                document.getElementById('tbHeaderPrime').style.display = showPrime ? 'flex' : 'none';

                this.state.tableDraft.forEach((col, i) => {
                    const div = document.createElement('div');
                    div.className = `tb-column ${col.type === 'int' ? 'interval' : ''}`;

                    // Ligne 1 : X input (only for val)
                    const c1 = document.createElement('div'); c1.className = 'tb-cell';
                    if (col.type === 'val') {
                        c1.innerHTML = `<input class="tb-input" value="${col.x}" oninput="app.state.tableDraft[${i}].x = this.value">`;
                    }
                    div.appendChild(c1);

                    // Ligne 2 : Sign Toggle (f') - Only if showPrime is true
                    if (showPrime) {
                        const c2 = document.createElement('div'); c2.className = 'tb-cell';
                        c2.innerHTML = `<button class="tb-btn" onclick="app.cycleSign(${i})">${col.sign || '&nbsp;'}</button>`;
                        div.appendChild(c2);
                    }

                    // Ligne 3 : Var/Arrow Toggle (f)
                    const c3 = document.createElement('div'); c3.className = 'tb-cell';
                    if (col.type === 'val') {
                        c3.innerHTML = `<input class="tb-input" value="${col.var}" placeholder="f(x)" oninput="app.state.tableDraft[${i}].var = this.value">`;
                    } else {
                        const arrMap = { 'up': '‚Üó', 'down': '‚Üò' };
                        c3.innerHTML = `<button class="tb-btn" onclick="app.cycleArr(${i})">${arrMap[col.arr] || '&nbsp;'}</button>`;
                    }
                    div.appendChild(c3);

                    // Bouton Supprimer (sauf si trop peu de colonnes)
                    if (this.state.tableDraft.length > 3) {
                        const delBtn = document.createElement('button');
                        delBtn.className = 'btn-del-col';
                        delBtn.innerHTML = '√ó';
                        delBtn.onclick = () => app.removeTableCol(i);
                        div.appendChild(delBtn);
                    }

                    c.appendChild(div);
                });
            },

            cycleSign: function (i) {
                const opts = ['', '+', '-', '0', '|', '||'];
                const curr = this.state.tableDraft[i].sign || '';
                let idx = opts.indexOf(curr);
                idx = (idx + 1) % opts.length;
                this.state.tableDraft[i].sign = opts[idx];
                this.renderTableDraft();
            },
            cycleArr: function (i) {
                // Only for intervals
                if (this.state.tableDraft[i].type !== 'int') return;
                const opts = ['up', 'down'];
                const curr = this.state.tableDraft[i].arr || 'up';
                let idx = opts.indexOf(curr);
                idx = (idx + 1) % opts.length;
                this.state.tableDraft[i].arr = opts[idx];
                this.renderTableDraft();
            },
            addTableColumn: function () {
                // Add Interval + Value pair
                this.state.tableDraft.push({ type: 'int', sign: '+', arr: 'up' });
                this.state.tableDraft.push({ type: 'val', x: '?', sign: '0', var: '' });
                this.renderTableDraft();
            },
            removeTableCol: function (i) {
                // Remove column and its neighbor to keep Val-Int-Val structure
                if (i > 0) {
                    this.state.tableDraft.splice(i - 1, 2); // Remove prev and current
                } else {
                    this.state.tableDraft.splice(i, 2); // Remove current and next
                }
                this.renderTableDraft();
            },

            confirmTable: function () {
                if (this.state.isEditingTable && this.state.editingTableIndex > -1) {
                    // Update existing
                    this.saveState();
                    const t = this.state.tables[this.state.editingTableIndex];
                    // On met √† jour les donn√©es calcul√©es √† partir du draft
                    const newData = this.processTableDraft(this.state.tableDraft);
                    t.x = newData.x;
                    t.fprime = newData.fprime;
                    t.f = newData.f;
                    t.showFPrime = document.getElementById('showFPrime').checked;
                    t.draftData = JSON.parse(JSON.stringify(this.state.tableDraft)); // Update stored draft
                } else {
                    // Create new
                    this.addTable();
                }
                document.getElementById('table-modal').style.display = 'none';
                this.updateRender();
            },

            processTableDraft: function (draft) {
                const tableData = { x: [], fprime: [], f: [] };
                for (let i = 0; i < draft.length; i++) {
                    if (draft[i].type === 'val') {
                        tableData.x.push(draft[i].x);
                        // Current val sign (0, |)
                        let fp = { val: draft[i].sign, int: null };
                        let fv = { val: draft[i].var, arrow: null };

                        // Check next interval for sign and arrow
                        if (i + 1 < draft.length && draft[i + 1].type === 'int') {
                            fp.int = draft[i + 1].sign;
                            fv.arrow = draft[i + 1].arr;
                        }

                        tableData.fprime.push(fp);
                        tableData.f.push(fv);
                    }
                }
                return tableData;
            },

            addTable: function () {
                const draft = this.state.tableDraft;
                const showPrime = document.getElementById('showFPrime').checked;
                const tableData = this.processTableDraft(draft);

                // On ajoute les m√©tadonn√©es
                tableData.showFPrime = showPrime;
                tableData.pos = { x: this.state.width / 2 - 200, y: this.state.height / 2 - 80 };
                tableData.draftData = JSON.parse(JSON.stringify(draft)); // IMPORTANT : Sauvegarder l'√©tat brut pour l'√©dition

                this.saveState();
                if (!this.state.tables) this.state.tables = [];
                this.state.tables.push(tableData);
                this.updateRender();
            },
            deleteTable: function (index) {
                this.saveState();
                this.state.tables.splice(index, 1);
                this.updateRender();
            },

            renderObjectList: function () {
                this.ui.pointsList.innerHTML = '';
                if (this.state.points.length === 0) this.ui.pointsList.innerHTML = '<div class="empty-msg">Aucun point</div>';
                else {
                    const ul = document.createElement('ul'); ul.className = 'obj-list';
                    this.state.points.forEach((p, i) => {
                        const li = document.createElement('li'); li.className = `obj-item ${p.visible === false ? 'hidden-item' : ''}`;
                        const visIcon = (p.visible === false) ? 'üôà' : 'üëÅÔ∏è';
                        li.innerHTML = `
                            <div class="obj-info"><span class="obj-marker" style="background:${p.color}"></span><strong>${p.label}</strong> (${p.u}; ${p.v})</div>
                            <div class="obj-actions">
                                <button class="obj-btn obj-vis" onclick="app.toggleVisibility('point', ${i})" title="Afficher/Masquer">${visIcon}</button>
                                <button class="obj-btn obj-del" onclick="app.deleteItem('point', ${i})">√ó</button>
                            </div>`;
                        ul.appendChild(li);
                    });
                    this.ui.pointsList.appendChild(ul);
                }

                // LISTE DES TABLEAUX
                this.ui.tablesList.innerHTML = '';
                if (!this.state.tables || this.state.tables.length === 0) {
                    this.ui.tablesList.innerHTML = '<div class="empty-msg">Aucun tableau</div>';
                } else {
                    const ul = document.createElement('ul'); ul.className = 'obj-list';
                    this.state.tables.forEach((t, i) => {
                        const li = document.createElement('li'); li.className = `obj-item ${t.visible === false ? 'hidden-item' : ''}`;
                        const visIcon = (t.visible === false) ? 'üôà' : 'üëÅÔ∏è';
                        li.innerHTML = `
                            <div class="obj-info">Tableau (${t.x.length} cols)</div>
                            <div class="obj-actions">
                                <button class="obj-btn obj-vis" onclick="app.toggleVisibility('table', ${i})" title="Afficher/Masquer">${visIcon}</button>
                                <button class="obj-btn obj-del" onclick="app.deleteTable(${i})">√ó</button>
                            </div>`;
                        ul.appendChild(li);
                    });
                    this.ui.tablesList.appendChild(ul);
                }

                this.ui.linksList.innerHTML = '';
                const hasLinks = this.state.links.length > 0;
                const hasCurves = this.state.curves.length > 0;
                const hasCircles = this.state.circles && this.state.circles.length > 0;

                if (!hasLinks && !hasCurves && !hasCircles) this.ui.linksList.innerHTML = '<div class="empty-msg">Aucun objet g√©om√©trique</div>';
                else {
                    const ul = document.createElement('ul'); ul.className = 'obj-list';
                    this.state.links.forEach((l, i) => {
                        const p1 = this.state.points[l.from];
                        const p2 = this.state.points[l.to];
                        if (p1 && p2) {
                            const isVector = l.type === 'vector';
                            const typeName = isVector ? 'Vecteur' : 'Segment';
                            const notation = isVector ? `${p1.label}${p2.label}` : `[${p1.label}${p2.label}]`;
                            const li = document.createElement('li'); li.className = `obj-item ${l.visible === false ? 'hidden-item' : ''}`;
                            const visIcon = (l.visible === false) ? 'üôà' : 'üëÅÔ∏è';
                            li.innerHTML = `
                                <div class="obj-info"><span class="obj-marker" style="background:${l.color}; width:15px; border-radius:0; height:3px;"></span> ${typeName} ${notation}</div>
                                <div class="obj-actions">
                                    <button class="obj-btn obj-vis" onclick="app.toggleVisibility('link', ${i})">${visIcon}</button>
                                    <button class="obj-btn obj-del" onclick="app.deleteItem('link', ${i})">√ó</button>
                                </div>`;
                            ul.appendChild(li);
                        }
                    });
                    this.state.curves.forEach((c, i) => {
                        const li = document.createElement('li'); li.className = `obj-item ${c.visible === false ? 'hidden-item' : ''}`;
                        const visIcon = (c.visible === false) ? 'üôà' : 'üëÅÔ∏è';
                        li.innerHTML = `
                            <div class="obj-info"><span class="obj-marker" style="background:${c.color}; width:15px; border-radius:0; height:3px;"></span> Courbe (${c.pts.length} pts)</div>
                            <div class="obj-actions">
                                <button class="obj-btn obj-vis" onclick="app.toggleVisibility('curve', ${i})">${visIcon}</button>
                                <button class="obj-btn obj-del" onclick="app.deleteItem('curve', ${i})">√ó</button>
                            </div>`;
                        ul.appendChild(li);
                    });
                    if (this.state.circles) {
                        this.state.circles.forEach((c, i) => {
                            const p1 = this.state.points[c.center];
                            const p2 = this.state.points[c.edge];
                            if (p1 && p2) {
                                const li = document.createElement('li'); li.className = `obj-item ${c.visible === false ? 'hidden-item' : ''}`;
                                const visIcon = (c.visible === false) ? 'üôà' : 'üëÅÔ∏è';
                                li.innerHTML = `
                                    <div class="obj-info"><span class="obj-marker" style="background:transparent; border:2px solid ${c.color}; width:12px; height:12px; border-radius:50%;"></span> Cercle (C:${p1.label})</div>
                                    <div class="obj-actions">
                                        <button class="obj-btn obj-vis" onclick="app.toggleVisibility('circle', ${i})">${visIcon}</button>
                                        <button class="obj-btn obj-del" onclick="app.deleteItem('circle', ${i})">√ó</button>
                                    </div>`;
                                ul.appendChild(li);
                            }
                        });
                    }
                    this.ui.linksList.appendChild(ul);
                }

                // TEXTS
                this.ui.textsList.innerHTML = '';
                if (!this.state.texts || this.state.texts.length === 0) this.ui.textsList.innerHTML = '<div class="empty-msg">Aucun texte</div>';
                else {
                    const ul = document.createElement('ul'); ul.className = 'obj-list';
                    this.state.texts.forEach((t, i) => {
                        const li = document.createElement('li'); li.className = `obj-item ${t.visible === false ? 'hidden-item' : ''}`;
                        const visIcon = (t.visible === false) ? 'üôà' : 'üëÅÔ∏è';
                        li.innerHTML = `
                            <div class="obj-info"><strong>"</strong>${t.content}<strong>"</strong></div>
                            <div class="obj-actions">
                                <button class="obj-btn obj-vis" onclick="app.toggleVisibility('text', ${i})">${visIcon}</button>
                                <button class="obj-btn obj-del" onclick="app.deleteItem('text', ${i})">√ó</button>
                            </div>`;
                        ul.appendChild(li);
                    });
                    this.ui.textsList.appendChild(ul);
                }

                // FUNCTIONS LIST
                this.ui.funcsList.innerHTML = '';
                if (this.state.functions.length === 0) this.ui.funcsList.innerHTML = '<div class="empty-msg">Aucune fonction</div>';
                else {
                    const ul = document.createElement('ul'); ul.className = 'obj-list';
                    this.state.functions.forEach((f, i) => {
                        const li = document.createElement('li'); li.className = `obj-item ${f.visible === false ? 'hidden-item' : ''}`;
                        const visIcon = (f.visible === false) ? 'üôà' : 'üëÅÔ∏è';
                        li.innerHTML = `
                            <div class="obj-info"><span class="obj-marker" style="background:${f.color}; width:15px; height:3px; border-radius:0;"></span> <em>f(x) = ${f.expr}</em></div>
                            <div class="obj-actions">
                                <button class="obj-btn obj-vis" onclick="app.toggleVisibility('function', ${i})">${visIcon}</button>
                                <button class="obj-btn obj-del" onclick="app.deleteItem('function', ${i})">√ó</button>
                            </div>`;
                        ul.appendChild(li);
                    });
                    this.ui.funcsList.appendChild(ul);
                }
                this.generateSummary();
            },

            toggleVisibility: function (type, index) {
                this.saveState();
                let arr;
                if (type === 'point') arr = this.state.points;
                else if (type === 'link') arr = this.state.links;
                else if (type === 'curve') arr = this.state.curves;
                else if (type === 'circle') arr = this.state.circles;
                else if (type === 'text') arr = this.state.texts;
                else if (type === 'function') arr = this.state.functions;
                else if (type === 'table') arr = this.state.tables;

                if (arr && arr[index]) {
                    // Toggle undefined or true to false, false to true
                    arr[index].visible = (arr[index].visible === false) ? true : false;
                }
                this.updateRender();
            },

            generateSummary: function () {
                let txt = "";
                if (this.state.points.length > 0) { txt += "Points :\n"; this.state.points.forEach(p => { if (p.visible !== false) txt += `- ${p.label}(${p.u} ; ${p.v})\n`; }); }
                if (this.state.links.length > 0) { txt += "\nLiaisons :\n"; this.state.links.forEach(l => { if (l.visible === false) return; const p1 = this.state.points[l.from]; const p2 = this.state.points[l.to]; if (p1 && p2) { const type = l.type === 'vector' ? 'Vecteur' : 'Segment'; const notation = (l.type === 'vector') ? `${p1.label}${p2.label}` : `[${p1.label}${p2.label}]`; txt += `- ${type} ${notation}\n`; } }); }
                if (this.state.circles && this.state.circles.length > 0) { txt += "\nCercles :\n"; this.state.circles.forEach(c => { if (c.visible === false) return; const p1 = this.state.points[c.center]; const p2 = this.state.points[c.edge]; if (p1 && p2) txt += `- Cercle de centre ${p1.label} passant par ${p2.label}\n`; }); }
                if (this.state.functions.length > 0) { txt += "\nFonctions :\n"; this.state.functions.forEach(f => { if (f.visible !== false) txt += `- f(x) = ${f.expr}\n`; }); }
                this.ui.summary.value = txt;
            },

            deleteItem: function (type, index) {
                this.saveState();
                if (type === 'point') {
                    this.state.links = this.state.links.filter(l => l.from !== index && l.to !== index);
                    this.state.curves.forEach(c => { c.pts = c.pts.filter(pid => pid !== index); });
                    this.state.curves = this.state.curves.filter(c => c.pts.length > 1);
                    if (this.state.circles) this.state.circles = this.state.circles.filter(c => c.center !== index && c.edge !== index);
                    const shift = (idx) => idx > index ? idx - 1 : idx;
                    this.state.links.forEach(l => { l.from = shift(l.from); l.to = shift(l.to); });
                    this.state.curves.forEach(c => { c.pts = c.pts.map(pid => shift(pid)); });
                    if (this.state.circles) this.state.circles.forEach(c => { c.center = shift(c.center); c.edge = shift(c.edge); });
                    this.state.points.splice(index, 1);
                } else if (type === 'link') { this.state.links.splice(index, 1); }
                else if (type === 'curve') { this.state.curves.splice(index, 1); }
                else if (type === 'circle') { this.state.circles.splice(index, 1); }
                else if (type === 'text') { this.state.texts.splice(index, 1); }
                else if (type === 'function') { this.state.functions.splice(index, 1); }
                this.updateRender();
            },

            handlePointClick: function (e, index) {
                e.stopPropagation();
                if (this.state.interactionMode === 'link') {
                    if (this.state.tempLinkStart === null) { this.state.tempLinkStart = index; } else { if (this.state.tempLinkStart !== index) { this.saveState(); this.state.links.push({ from: this.state.tempLinkStart, to: index, type: document.getElementById('linkType').value, color: document.getElementById('linkColor').value, width: document.getElementById('linkWidth').value, dashed: document.getElementById('linkDashed').checked }); } this.state.tempLinkStart = null; }
                } else if (this.state.interactionMode === 'curve') {
                    this.state.activeCurve.push(index);
                } else if (this.state.interactionMode === 'circle') {
                    if (this.state.tempLinkStart === null) { this.state.tempLinkStart = index; } else { if (this.state.tempLinkStart !== index) { this.saveState(); if (!this.state.circles) this.state.circles = []; this.state.circles.push({ center: this.state.tempLinkStart, edge: index, color: document.getElementById('linkColor').value, width: document.getElementById('linkWidth').value, dashed: document.getElementById('linkDashed').checked }); } this.state.tempLinkStart = null; }
                }
                this.updateRender();
            },

            finishCurve: function () {
                if (this.state.activeCurve.length > 1) { this.saveState(); this.state.curves.push({ pts: [...this.state.activeCurve], color: document.getElementById('linkColor').value, width: document.getElementById('linkWidth').value, dashed: document.getElementById('linkDashed').checked }); }
                this.state.activeCurve = []; this.updateRender();
            },

            addFunction: function () {
                const expr = document.getElementById('funcInput').value; if (!expr) return;
                try { const safeExpr = this.cleanFormula(expr); new Function('x', 'return ' + safeExpr)(0); this.saveState(); this.state.functions.push({ expr: expr, safeExpr: safeExpr, color: document.getElementById('funcColor').value, width: document.getElementById('funcWidth').value }); this.updateRender(); } catch (e) { alert("Erreur de syntaxe."); }
            },
            cleanFormula: function (expr) { return expr.toLowerCase().replace(/\^/g, '**').replace(/sin/g, 'Math.sin').replace(/cos/g, 'Math.cos').replace(/tan/g, 'Math.tan').replace(/sqrt/g, 'Math.sqrt').replace(/abs/g, 'Math.abs').replace(/ln/g, 'Math.log').replace(/exp/g, 'Math.exp').replace(/pi/g, 'Math.PI'); },

            openExportModal: function () { document.getElementById('export-modal').style.display = 'flex'; },
            openHelpModal: function () { document.getElementById('help-modal').style.display = 'flex'; },

            performExport: function (action) {
                const format = document.getElementById('exportFormat').value;
                if (format === 'tikz') {
                    const code = this.generateTikZ();
                    if (action === 'copy') { navigator.clipboard.writeText(code).then(() => app.showToast("Code LaTeX copi√© !")); } else { const blob = new Blob([code], { type: 'text/plain' }); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = "figure.tex"; link.click(); }
                    document.getElementById('export-modal').style.display = 'none'; return;
                }
                const currentZoom = this.state.viewZoom; this.state.viewZoom = 1; this.applyZoomCSS();
                const scale = parseInt(document.getElementById('exportQuality').value);
                const svgEl = this.ui.wrapper.querySelector('svg');
                if (format === 'svg') { const data = new XMLSerializer().serializeToString(svgEl); const blob = new Blob([data], { type: 'image/svg+xml' }); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = `Grille.svg`; link.click(); } else {
                    const canvas = document.createElement('canvas'); canvas.width = this.state.width * scale; canvas.height = this.state.height * scale; const ctx = canvas.getContext('2d'); const data = new XMLSerializer().serializeToString(svgEl); const img = new Image(); const svgBlob = new Blob([data], { type: 'image/svg+xml;charset=utf-8' }); const url = URL.createObjectURL(svgBlob);
                    img.onload = function () { ctx.fillStyle = "white"; ctx.fillRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); canvas.toBlob(function (blob) { if (action === 'copy') { try { navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]).then(() => app.showToast("Image copi√©e !")); } catch (err) { alert('Navigateur non support√©.'); } } else { const link = document.createElement('a'); link.download = `Grille.png`; link.href = URL.createObjectURL(blob); link.click(); } URL.revokeObjectURL(url); }); }; img.src = url;
                }
                this.state.viewZoom = currentZoom; this.applyZoomCSS(); document.getElementById('export-modal').style.display = 'none';
            },

            showToast: function (msg) { const t = document.getElementById('toast'); t.textContent = msg || "Op√©ration effectu√©e"; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); },
            showCtxMenu: function (e, type, index) {
                e.preventDefault(); e.stopPropagation(); this.state.activeContext = { type, index }; const menu = this.ui.ctxMenu;

                // Reset display
                document.getElementById('ctxEditBtn').style.display = 'none';

                if (type === 'table') {
                    document.getElementById('ctxTitle').innerText = "Modifier Tableau";
                    document.getElementById('ctxNameRow').style.display = 'none';
                    document.getElementById('ctxShowCoordsRow').style.display = 'none';
                    document.getElementById('ctxColorRow').style.display = 'none';
                    document.getElementById('ctxEditBtn').style.display = 'block';
                }
                else if (type === 'point') {
                    const p = this.state.points[index]; document.getElementById('ctxTitle').innerText = "Modifier Point"; document.getElementById('ctxNameRow').style.display = 'block'; document.getElementById('ctxName').value = p.label; document.getElementById('ctxShowCoordsRow').style.display = 'block'; document.getElementById('ctxShowCoords').checked = p.showCoords || false; document.getElementById('ctxColorRow').style.display = 'block'; document.getElementById('ctxColor').value = p.color;
                } else if (type === 'text') {
                    const t = this.state.texts[index]; document.getElementById('ctxTitle').innerText = "Modifier Texte"; document.getElementById('ctxNameRow').style.display = 'block'; document.getElementById('ctxName').value = t.content; document.getElementById('ctxShowCoordsRow').style.display = 'none'; document.getElementById('ctxColorRow').style.display = 'block'; document.getElementById('ctxColor').value = t.color;
                } else { let l; if (type === 'link') l = this.state.links[index]; else if (type === 'curve') l = this.state.curves[index]; else if (type === 'circle') l = this.state.circles[index]; else if (type === 'function') l = this.state.functions[index]; document.getElementById('ctxTitle').innerText = "Modifier"; document.getElementById('ctxNameRow').style.display = 'none'; document.getElementById('ctxShowCoordsRow').style.display = 'none'; document.getElementById('ctxColorRow').style.display = 'block'; document.getElementById('ctxColor').value = l.color; }
                const parentRect = document.getElementById('preview-container').getBoundingClientRect(); const relX = (e.clientX - parentRect.left) / this.state.viewZoom; const relY = (e.clientY - parentRect.top) / this.state.viewZoom; menu.style.display = 'block'; menu.style.left = relX + 'px'; menu.style.top = relY + 'px';
            },
            hideCtxMenu: function () { this.ui.ctxMenu.style.display = 'none'; },
            updateFromCtx: function (prop, val) {
                if (!this.state.activeContext) return; const { type, index } = this.state.activeContext;
                if (type === 'point') this.state.points[index][prop] = val;
                else if (type === 'text') { if (prop === 'label') this.state.texts[index].content = val; if (prop === 'color') this.state.texts[index].color = val; }
                else if (type === 'link') { if (prop === 'color') this.state.links[index].color = val; }
                else if (type === 'curve') { if (prop === 'color') this.state.curves[index].color = val; }
                else if (type === 'circle') { if (prop === 'color') this.state.circles[index].color = val; }
                else if (type === 'function') { if (prop === 'color') this.state.functions[index].color = val; }
                this.updateRender();
            },
            deleteActiveItem: function () { if (!this.state.activeContext) return; this.deleteItem(this.state.activeContext.type, this.state.activeContext.index); this.state.activeContext = null; this.hideCtxMenu(); },
            getAvailableLabel: function () { const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"; let i = 0; while (true) { const charIndex = i % 26; const cycle = Math.floor(i / 26); const suffix = "'".repeat(cycle); const candidate = alphabet[charIndex] + suffix; if (!this.state.points.some(p => p.label === candidate)) return candidate; i++; } },
            getMousePos: function (e) { const rect = this.ui.wrapper.getBoundingClientRect(); return { x: (e.clientX - rect.left) / this.state.viewZoom, y: (e.clientY - rect.top) / this.state.viewZoom }; },
            addPoint: function (e) { this.saveState(); const pos = this.getMousePos(e); let lu = (pos.x - this.state.axisX) / this.state.baseUnit; let lv = (this.state.axisY - pos.y) / this.state.baseUnit; if (this.state.magnetMode) { lu = Math.round(lu * 10) / 10; lv = Math.round(lv * 10) / 10; } this.state.points.push({ u: lu, v: lv, label: this.getAvailableLabel(), color: "#e74c3c", showCoords: false }); this.updateRender(); return this.state.points.length - 1; },

            addText: function (e) { const pos = this.getMousePos(e); let lu = (pos.x - this.state.axisX) / this.state.baseUnit; let lv = (this.state.axisY - pos.y) / this.state.baseUnit; this.state.tempTextPos = { u: lu, v: lv }; this.ui.floatingInput.style.display = 'block'; this.ui.floatingInput.style.left = e.clientX + 'px'; this.ui.floatingInput.style.top = e.clientY + 'px'; this.ui.floatingInput.value = ''; this.ui.floatingInput.focus(); },
            confirmText: function () { const content = this.ui.floatingInput.value.trim(); if (content && this.state.tempTextPos) { this.saveState(); if (!this.state.texts) this.state.texts = []; this.state.texts.push({ u: this.state.tempTextPos.u, v: this.state.tempTextPos.v, content: content, color: "#333" }); this.updateRender(); this.setMode('move'); } this.cancelText(); },
            cancelText: function () { this.ui.floatingInput.style.display = 'none'; this.ui.floatingInput.value = ''; this.state.tempTextPos = null; },
            recenterAxes: function () { this.saveState(); this.state.axisX = this.state.width / 2; this.state.axisY = this.state.height / 2; this.updateRender(); },
            getSmoothPath: function (ptIndices) { if (ptIndices.length < 2) return ""; const coords = ptIndices.map(i => { const p = this.state.points[i]; return { x: this.state.axisX + p.u * this.state.baseUnit, y: this.state.axisY - p.v * this.state.baseUnit }; }); if (coords.length === 2) return `M ${coords[0].x} ${coords[0].y} L ${coords[1].x} ${coords[1].y}`; let d = `M ${coords[0].x} ${coords[0].y}`; for (let i = 0; i < coords.length - 1; i++) { const p0 = coords[i === 0 ? 0 : i - 1]; const p1 = coords[i]; const p2 = coords[i + 1]; const p3 = coords[i + 2] || p2; const cp1x = p1.x + (p2.x - p0.x) / 6; const cp1y = p1.y + (p2.y - p0.y) / 6; const cp2x = p2.x - (p3.x - p1.x) / 6; const cp2y = p2.y - (p3.y - p1.y) / 6; d += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`; } return d; },
            renderGhost: function (pos) { if (this.state.interactionMode !== 'point') return ""; let lu = (pos.x - this.state.axisX) / this.state.baseUnit; let lv = (this.state.axisY - pos.y) / this.state.baseUnit; if (this.state.magnetMode) { lu = Math.round(lu * 10) / 10; lv = Math.round(lv * 10) / 10; } const px = this.state.axisX + lu * this.state.baseUnit; const py = this.state.axisY - lv * this.state.baseUnit; const col = "#e74c3c"; let svg = `<g style="pointer-events:none;">`; svg += `<line x1="${px}" y1="${py}" x2="${px}" y2="${this.state.axisY}" stroke="${col}" stroke-width="1" stroke-dasharray="4,4" opacity="0.6"/>`; svg += `<line x1="${px}" y1="${py}" x2="${this.state.axisX}" y2="${py}" stroke="${col}" stroke-width="1" stroke-dasharray="4,4" opacity="0.6"/>`; const s = 5; svg += `<path d="M ${px - s} ${py - s} L ${px + s} ${py + s} M ${px - s} ${py + s} L ${px + s} ${py - s}" stroke="${col}" stroke-width="2"/>`; svg += `<text x="${px + 8}" y="${py - 8}" font-family="Arial" font-size="12" fill="${col}" font-weight="bold">(${lu}; ${lv})</text></g>`; return svg; },
            setMode: function (mode) { if (this.state.activeCurve.length > 0) this.finishCurve(); this.state.interactionMode = mode; this.state.tempLinkStart = null; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); const instructions = { 'move': "D√©placez les axes ou redimensionnez.", 'point': "Cliquez pour placer un point.", 'link': "Clic point d√©part -> Clic point arriv√©e.", 'curve': "Clics successifs. 'Entr√©e' pour finir.", 'circle': "Clic centre -> Clic point du bord.", 'text': "Cliquez pour √©crire.", 'function': "Remplissez f(x) √† gauche." }; if (instructions[mode]) this.showToast(instructions[mode]); const mapBtn = { 'move': 'btnModeMove', 'point': 'btnModePoint', 'link': 'btnModeLink', 'curve': 'btnModeCurve', 'circle': 'btnModeCircle', 'text': 'btnModeText', 'function': 'btnModeFunction' }; if (mapBtn[mode]) document.getElementById(mapBtn[mode]).classList.add('active'); this.ui.wrapper.style.cursor = (mode === 'move') ? 'default' : (mode === 'point' ? 'crosshair' : 'pointer'); document.getElementById('tool-settings-panel').style.display = (mode === 'link' || mode === 'curve' || mode === 'circle') ? 'block' : 'none'; document.getElementById('function-settings-panel').style.display = (mode === 'function') ? 'block' : 'none'; this.updateRender(); },
            zoomView: function (delta) { this.state.viewZoom += delta; if (this.state.viewZoom < 0.2) this.state.viewZoom = 0.2; if (this.state.viewZoom > 5) this.state.viewZoom = 5; this.applyZoomCSS(); },
            applyZoomCSS: function () { this.ui.wrapper.style.transform = `scale(${this.state.viewZoom})`; },
            zoom: function (delta) { this.zoomView(delta > 0 ? 0.1 : -0.1); },
            applySizePreset: function () { this.saveState(); const val = document.getElementById('sizePreset').value; if (val === 'custom') return; const size = this.presets.sizes[val]; this.setSize(size.w, size.h); },
            setSize: function (w, h) { this.state.width = w; this.state.height = h; this.state.axisX = w / 2; this.state.axisY = h / 2; this.syncUI(); this.updateRender(); },
            syncUI: function () { this.ui.inputs.w.value = Math.round(this.state.width); this.ui.inputs.h.value = Math.round(this.state.height); this.ui.wrapper.style.width = this.state.width + 'px'; this.ui.wrapper.style.height = this.state.height + 'px'; },
            drag: { active: false, startX: 0, startY: 0, startW: 0, startH: 0, startAx: 0, startAy: 0 },
            startResize: function (e, dir) { e.stopPropagation(); this.drag = { active: true, mode: 'resize', dir: dir, startX: e.clientX, startY: e.clientY, startW: this.state.width, startH: this.state.height }; this.ui.wrapper.classList.add('no-transition'); this.ui.overlay.classList.add('visible'); },
            startAxesDrag: function (e) { this.drag = { active: true, mode: 'axes', startX: e.clientX, startY: e.clientY, startAx: this.state.axisX, startAy: this.state.axisY }; this.ui.wrapper.style.cursor = 'move'; },
            onMouseMove: function (e) {
                const pos = this.getMousePos(e); if (!this.drag.active && this.state.interactionMode === 'point') { let ghostG = document.getElementById('ghost-layer'); if (!ghostG) { if (this.ui.wrapper.querySelector('svg')) this.updateRender(); return; } ghostG.innerHTML = this.renderGhost(pos); } if (!this.drag.active && ((this.state.interactionMode === 'link' && this.state.tempLinkStart !== null) || (this.state.interactionMode === 'circle' && this.state.tempLinkStart !== null) || (this.state.interactionMode === 'curve' && this.state.activeCurve.length > 0))) { let ghostG = document.getElementById('ghost-layer'); if (ghostG) { const startIdx = (this.state.interactionMode === 'link' || this.state.interactionMode === 'circle') ? this.state.tempLinkStart : this.state.activeCurve[this.state.activeCurve.length - 1]; const p1 = this.state.points[startIdx]; const x1 = this.state.axisX + p1.u * this.state.baseUnit; const y1 = this.state.axisY - p1.v * this.state.baseUnit; let lu = (pos.x - this.state.axisX) / this.state.baseUnit; let lv = (this.state.axisY - pos.y) / this.state.baseUnit; if (this.state.magnetMode) { lu = Math.round(lu * 2) / 2; lv = Math.round(lv * 2) / 2; } const x2 = this.state.axisX + lu * this.state.baseUnit; const y2 = this.state.axisY - lv * this.state.baseUnit; let snapped = false; this.state.points.forEach((p, i) => { if (i !== startIdx) { const px = this.state.axisX + p.u * this.state.baseUnit; const py = this.state.axisY - p.v * this.state.baseUnit; if (Math.abs(pos.x - px) < 15 && Math.abs(pos.y - py) < 15) { if (this.state.interactionMode === 'circle') { const r = Math.sqrt(Math.pow(px - x1, 2) + Math.pow(py - y1, 2)); ghostG.innerHTML = `<circle cx="${x1}" cy="${y1}" r="${r}" stroke="#27ae60" stroke-width="2" stroke-dasharray="5,5" fill="none" />`; } else { ghostG.innerHTML = `<line x1="${x1}" y1="${y1}" x2="${px}" y2="${py}" stroke="#27ae60" stroke-width="2" stroke-dasharray="5,5"/>`; } snapped = true; return; } } }); if (!snapped) { if (this.state.interactionMode === 'circle') { const r = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)); ghostG.innerHTML = `<circle cx="${x1}" cy="${y1}" r="${r}" stroke="#27ae60" stroke-width="2" stroke-dasharray="5,5" fill="none" />`; } else { ghostG.innerHTML = `<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" stroke="#27ae60" stroke-width="2" stroke-dasharray="5,5"/>`; } } } } if (this.drag.active) {
                    e.preventDefault(); const dx = e.clientX - this.drag.startX; const dy = e.clientY - this.drag.startY; if (this.drag.mode === 'resize') { const scale = this.state.viewZoom; let newW = this.drag.startW; let newH = this.drag.startH; if (this.drag.dir.includes('e')) newW += (dx / scale) * 2; if (this.drag.dir.includes('s')) newH += (dy / scale) * 2; if (newW < 100) newW = 100; if (newH < 100) newH = 100; this.state.width = newW; this.state.height = newH; this.state.axisX = newW / 2; this.state.axisY = newH / 2; this.syncUI(); document.getElementById('sizePreset').value = 'custom'; this.updateRender(); } else if (this.drag.mode === 'axes') { const scale = this.state.viewZoom; let nx = this.drag.startAx + (dx / scale); let ny = this.drag.startAy + (dy / scale); if (this.state.magnetMode) { nx = Math.round(nx / this.state.baseUnit) * this.state.baseUnit; ny = Math.round(ny / this.state.baseUnit) * this.state.baseUnit; } this.state.axisX = nx; this.state.axisY = ny; this.updateRender(); }

                    // --- LOGIQUE DRAG TABLEAU ---
                    else if (this.drag.mode === 'table') {
                        const scale = this.state.viewZoom;
                        const idx = this.drag.idx;
                        this.state.tables[idx].pos.x = this.drag.originX + (dx / scale);
                        this.state.tables[idx].pos.y = this.drag.originY + (dy / scale);
                        this.updateRender();
                    }

                } if (this.state.interactionMode === 'move') { if (e.target.closest('#canvas-wrapper') && !e.target.classList.contains('resize-handle')) { const nearVert = Math.abs(pos.x - this.state.axisX) < 15; const nearHoriz = Math.abs(pos.y - this.state.axisY) < 15; if (nearVert || nearHoriz) this.ui.wrapper.style.cursor = 'move'; else this.ui.wrapper.style.cursor = 'default'; } }
            },
            onMouseUp: function () { if (this.drag.active && (this.drag.mode === 'resize' || this.drag.mode === 'axes')) { this.saveState(); } this.drag.active = false; this.ui.overlay.classList.remove('visible'); this.ui.wrapper.classList.remove('no-transition'); },

            // --- FONCTION TIKZ (√âpaisseurs pr√©cises en 'pt' + Tableaux + COULEURS HEX 6 DIGITS) ---
            generateTikZ: function () {
                const minU = -this.state.axisX / this.state.baseUnit;
                const maxU = (this.state.width - this.state.axisX) / this.state.baseUnit;
                const maxV = this.state.axisY / this.state.baseUnit;
                const minV = (this.state.axisY - this.state.height) / this.state.baseUnit;

                const colorsUsed = new Set();
                const getColor = (hex) => {
                    if (!hex) return 'black';
                    hex = hex.toLowerCase();
                    if (hex === '#000000' || hex === 'black') return 'black';
                    if (hex === '#ffffff' || hex === 'white') return 'white';
                    if (hex === '#ff0000') return 'red';
                    if (hex === '#00ff00') return 'green';
                    if (hex === '#0000ff') return 'blue';
                    const cName = "c" + hex.replace('#', '');
                    colorsUsed.add(hex);
                    return cName;
                };

                const getWidth = (w) => (w * 0.8).toFixed(2);
                const fmt = (n) => n.toFixed(2);

                let content = "";

                // 1. Grille
                this.state.layers.forEach(l => {
                    const step = l.m;
                    const col = getColor(l.c);
                    const width = getWidth(l.w);

                    let style = `, line width=${width}pt`;
                    if (l.s === 'dash') style += ', dashed';
                    if (l.s === 'dot') style += ', dotted';
                    if (l.s === 'shortdash') style += ', dash pattern=on 2pt off 2pt';

                    const startX = Math.floor(minU / step) * step;
                    const endX = Math.ceil(maxU / step) * step;
                    const startY = Math.floor(minV / step) * step;
                    const endY = Math.ceil(maxV / step) * step;

                    content += `    % Grille ${l.name}\n`;
                    content += `    \\draw[color=${col}, step=${step}${style}] (${fmt(startX)},${fmt(startY)}) grid (${fmt(endX)},${fmt(endY)});\n`;
                });

                // 2. Axes
                if (this.state.showAxes) {
                    content += `    % Axes\n`;
                    content += `    \\draw[->, line width=1.2pt] (${fmt(minU)},0) -- (${fmt(maxU)},0) node[right] {$x$};\n`;
                    content += `    \\draw[->, line width=1.2pt] (0,${fmt(minV)}) -- (0,${fmt(maxV)}) node[above] {$y$};\n`;

                    if (this.state.showLabels) {
                        const startX = Math.ceil(minU); const endX = Math.floor(maxU);
                        for (let i = startX; i <= endX; i++) {
                            if (i !== 0) content += `    \\draw (${i},0.1) -- (${i},-0.1) node[below] {\\small ${i}};\n`;
                        }
                        const startY = Math.ceil(minV); const endY = Math.floor(maxV);
                        for (let i = startY; i <= endY; i++) {
                            if (i !== 0) content += `    \\draw (0.1,${i}) -- (-0.1,${i}) node[left] {\\small ${i}};\n`;
                        }
                    }
                }

                // 3. Objets g√©om√©triques
                content += `    % Objets\n`;

                this.state.links.forEach(l => {
                    if (l.visible === false) return; // Skip invisible
                    const p1 = this.state.points[l.from];
                    const p2 = this.state.points[l.to];
                    const col = getColor(l.color);
                    const style = l.dashed ? ', dashed' : '';
                    const arrow = l.type === 'vector' ? ', ->, >=latex' : '';
                    content += `    \\draw[color=${col}, line width=${getWidth(l.width)}pt${style}${arrow}] (${p1.u},${p1.v}) -- (${p2.u},${p2.v});\n`;
                });

                if (this.state.circles) {
                    this.state.circles.forEach(c => {
                        if (c.visible === false) return;
                        const p1 = this.state.points[c.center];
                        const p2 = this.state.points[c.edge];
                        const r = Math.sqrt(Math.pow(p2.u - p1.u, 2) + Math.pow(p2.v - p1.v, 2));
                        const col = getColor(c.color);
                        const style = c.dashed ? ', dashed' : '';
                        content += `    \\draw[color=${col}, line width=${getWidth(c.width)}pt${style}] (${p1.u},${p1.v}) circle (${fmt(r)});\n`;
                    });
                }

                this.state.curves.forEach(c => {
                    if (c.visible === false) return;
                    const col = getColor(c.color);
                    const style = c.dashed ? ', dashed' : '';
                    let ptsStr = "";
                    c.pts.forEach(pid => {
                        const p = this.state.points[pid];
                        ptsStr += `(${p.u},${p.v}) `;
                    });
                    content += `    \\draw[color=${col}, line width=${getWidth(c.width)}pt${style}] plot [smooth, tension=0.7] coordinates { ${ptsStr} };\n`;
                });

                this.state.functions.forEach(f => {
                    if (f.visible === false) return;
                    const col = getColor(f.color);
                    let expr = f.expr.replace(/\*\*/g, '^');
                    expr = expr.replace(/(^|[^a-zA-Z\\])x([^a-zA-Z]|$)/g, '$1\\x$2');
                    expr = expr.replace(/sin\(\\x\)/g, 'sin(\\x r)')
                        .replace(/cos\(\\x\)/g, 'cos(\\x r)')
                        .replace(/tan\(\\x\)/g, 'tan(\\x r)');

                    content += `    \\draw[color=${col}, line width=${getWidth(f.width)}pt, samples=100, smooth, domain=${fmt(minU)}:${fmt(maxU)}] plot (\\x, {${expr}});\n`;
                });

                this.state.points.forEach(p => {
                    if (p.visible === false) return;
                    const col = getColor(p.color);
                    const s = 0.15;
                    const x = p.u; const y = p.v;
                    const x1 = fmt(x - s); const x2 = fmt(x + s);
                    const y1 = fmt(y - s); const y2 = fmt(y + s);

                    content += `    % Point ${p.label}\n`;
                    content += `    \\draw[color=${col}, line width=1.2pt] (${x1},${y1}) -- (${x2},${y2});\n`;
                    content += `    \\draw[color=${col}, line width=1.2pt] (${x1},${y2}) -- (${x2},${y1});\n`;
                    content += `    \\node[color=${col}] at (${fmt(x + 0.2)},${fmt(y + 0.2)}) {${p.label}};\n`;
                });

                if (this.state.texts) {
                    this.state.texts.forEach(t => {
                        if (t.visible === false) return;
                        const col = getColor(t.color);
                        const safeText = t.content.replace(/_/g, '\\_').replace(/%/g, '\\%');
                        content += `    \\node[color=${col}, anchor=center] at (${t.u},${t.v}) {${safeText}};\n`;
                    });
                }

                if (this.state.tables) {
                    content += `    % Tableaux de variation (Dessin manuel)\n`;
                    this.state.tables.forEach(t => {
                        if (t.visible === false) return;
                        const tx = (t.pos.x - this.state.axisX) / this.state.baseUnit;
                        const ty = (this.state.axisY - t.pos.y) / this.state.baseUnit;
                        const hasPrime = t.showFPrime !== false; // Default true

                        const rowH = 0.8;
                        const colW = 1.5;
                        const totalW = (t.x.length * 2 - 1) * colW;
                        const totalRows = hasPrime ? 3 : 2;

                        content += `    \\draw (${fmt(tx)},${fmt(ty)}) rectangle (${fmt(tx + totalW)},${fmt(ty - rowH * totalRows)});\n`;
                        content += `    \\draw (${fmt(tx)},${fmt(ty - rowH)}) -- (${fmt(tx + totalW)},${fmt(ty - rowH)});\n`;

                        if (hasPrime) {
                            content += `    \\draw (${fmt(tx)},${fmt(ty - rowH * 2)}) -- (${fmt(tx + totalW)},${fmt(ty - rowH * 2)});\n`;
                        }

                        content += `    \\draw (${fmt(tx + colW)},${fmt(ty)}) -- (${fmt(tx + colW)},${fmt(ty - rowH * totalRows)});\n`;

                        content += `    \\node at (${fmt(tx + colW / 2)},${fmt(ty - rowH / 2)}) {$x$};\n`;

                        if (hasPrime) {
                            content += `    \\node at (${fmt(tx + colW / 2)},${fmt(ty - rowH * 1.5)}) {$f'(x)$};\n`;
                            content += `    \\node at (${fmt(tx + colW / 2)},${fmt(ty - rowH * 2.5)}) {$f(x)$};\n`;
                        } else {
                            content += `    \\node at (${fmt(tx + colW / 2)},${fmt(ty - rowH * 1.5)}) {$f(x)$};\n`;
                        }

                        // Dessin des valeurs dans le tableau TikZ
                        let curX = tx + colW; // On commence apr√®s l'en-t√™te

                        t.x.forEach((val, idx) => {
                            // Valeur X (toujours au centre de la case)
                            content += `    \\node at (${fmt(curX + colW / 2)},${fmt(ty - rowH / 2)}) {${val}};\n`;

                            // Ligne pointill√©e verticale sous X (sauf si c'est la derni√®re valeur et pas un tableau infini)
                            // En g√©n√©ral on veut pointill√© jusqu'en bas
                            content += `    \\draw[dashed] (${fmt(curX + colW / 2)},${fmt(ty - rowH)}) -- (${fmt(curX + colW / 2)},${fmt(ty - rowH * totalRows)});\n`;

                            // f'(x)
                            if (hasPrime) {
                                const fprimeVal = t.fprime[idx].val;
                                if (fprimeVal && fprimeVal !== "") {
                                    // Si c'est 0, on met un 0
                                    if (fprimeVal === '0') content += `    \\node at (${fmt(curX + colW / 2)},${fmt(ty - rowH * 1.5)}) {0};\n`;
                                    // Si c'est |, double barre pour valeur interdite
                                    if (fprimeVal === '|') content += `    \\draw[double] (${fmt(curX + colW / 2)},${fmt(ty - rowH)}) -- (${fmt(curX + colW / 2)},${fmt(ty - rowH * totalRows)});\n`;
                                    if (fprimeVal === '||') content += `    \\draw[double] (${fmt(curX + colW / 2)},${fmt(ty - rowH)}) -- (${fmt(curX + colW / 2)},${fmt(ty - rowH * totalRows)});\n`;
                                }
                            }

                            // f(x) valeurs aux bornes
                            const fVal = t.f[idx].val;
                            if (fVal && fVal !== "") {
                                const fY = hasPrime ? ty - rowH * 2.5 : ty - rowH * 1.5;
                                content += `    \\node at (${fmt(curX + colW / 2)},${fmt(fY)}) {${fVal}};\n`;
                            }

                            // Intervalle suivant (Signes et Fl√®ches)
                            if (idx < t.x.length - 1) {
                                curX += colW; // On avance dans la case intervalle

                                if (hasPrime) {
                                    const sign = t.fprime[idx].int;
                                    if (sign) content += `    \\node at (${fmt(curX + colW / 2)},${fmt(ty - rowH * 1.5)}) {${sign}};\n`;
                                }

                                const arr = t.f[idx].arrow;
                                if (arr) {
                                    const fYTop = hasPrime ? ty - rowH * 2 : ty - rowH;
                                    const fYBot = hasPrime ? ty - rowH * 3 : ty - rowH * 2;
                                    const arrowX1 = curX + 0.2;
                                    const arrowX2 = curX + colW - 0.2;

                                    if (arr === 'up') {
                                        content += `    \\draw[->] (${fmt(arrowX1)},${fmt(fYBot + 0.2)}) -- (${fmt(arrowX2)},${fmt(fYTop - 0.2)});\n`;
                                    } else {
                                        content += `    \\draw[->] (${fmt(arrowX1)},${fmt(fYTop - 0.2)}) -- (${fmt(arrowX2)},${fmt(fYBot + 0.2)});\n`;
                                    }
                                }
                                curX += colW; // On avance pour la prochaine valeur
                            }
                        });
                    });
                }

                let head = `\\begin{tikzpicture}[line cap=round, line join=round]\n`;
                colorsUsed.forEach(hex => {
                    const cName = "c" + hex.replace('#', '');
                    let cleanHex = hex.replace('#', '');
                    if (cleanHex.length === 3) cleanHex = cleanHex.split('').map(c => c + c).join('');
                    head += `    \\definecolor{${cName}}{HTML}{${cleanHex.toUpperCase()}}\n`;
                });

                head += `    \\clip (${fmt(minU)},${fmt(minV)}) rectangle (${fmt(maxU)},${fmt(maxV)});\n`;

                return head + content + `\\end{tikzpicture}`;
            },

            updateRender: function () {
                if (!this.state.layers || !this.state.width) return;

                const axesEl = document.getElementById('showAxes');
                if (axesEl) this.state.showAxes = axesEl.checked;

                this.state.showLabels = document.getElementById('showLabels') ? document.getElementById('showLabels').checked : false;
                this.state.showTicks = document.getElementById('showTicks') ? document.getElementById('showTicks').checked : false;
                this.state.labelStyle = document.getElementById('labelStyle') ? document.getElementById('labelStyle').value : 'badge';
                this.state.margin = parseInt(document.getElementById('margin').value) || 0;
                this.state.labelFont = document.getElementById('fontFamily') ? document.getElementById('fontFamily').value : 'Arial';
                this.state.labelFontSize = parseInt(document.getElementById('fontSize').value) || 12;

                const oldSvg = this.ui.wrapper.querySelector('svg'); if (oldSvg) oldSvg.remove();

                const ns = "http://www.w3.org/2000/svg";
                const svg = document.createElementNS(ns, "svg");
                svg.setAttribute("width", "100%"); svg.setAttribute("height", "100%");
                svg.setAttribute("viewBox", `0 0 ${this.state.width} ${this.state.height}`);
                svg.setAttribute("shape-rendering", "crispEdges");

                // Clip
                const defs = document.createElementNS(ns, "defs");
                const clipPath = document.createElementNS(ns, "clipPath");
                clipPath.setAttribute("id", "marginClip");
                const rect = document.createElementNS(ns, "rect");
                rect.setAttribute("x", this.state.margin); rect.setAttribute("y", this.state.margin);
                rect.setAttribute("width", Math.max(0, this.state.width - 2 * this.state.margin));
                rect.setAttribute("height", Math.max(0, this.state.height - 2 * this.state.margin));
                clipPath.appendChild(rect); defs.appendChild(clipPath); svg.appendChild(defs);

                const mainGroup = document.createElementNS(ns, "g");
                mainGroup.setAttribute("clip-path", "url(#marginClip)");

                // Grids
                [...this.state.layers].sort((a, b) => a.m - b.m).forEach(l => {
                    const step = l.m * this.state.baseUnit;
                    const g = document.createElementNS(ns, "g");
                    g.setAttribute("stroke", l.c); g.setAttribute("stroke-width", l.w);
                    if (this.lineStyles[l.s] !== "none") g.setAttribute("stroke-dasharray", this.lineStyles[l.s]);
                    let d = ""; const dir = l.dir || 'both';
                    if (dir !== 'h') { const offX = this.state.axisX % step; for (let x = offX; x <= this.state.width; x += step) d += `M ${Math.round(x)} 0 V ${this.state.height} `; }
                    if (dir !== 'v') { const offY = this.state.axisY % step; for (let y = offY; y <= this.state.height; y += step) d += `M 0 ${Math.round(y)} H ${this.state.width} `; }
                    const p = document.createElementNS(ns, "path"); p.setAttribute("d", d); p.setAttribute("fill", "none");
                    g.appendChild(p); mainGroup.appendChild(g);
                });

                if (this.state.showAxes) {
                    const ax = Math.round(this.state.axisX);
                    const ay = Math.round(this.state.axisY);
                    const m = this.state.margin; // On r√©cup√®re la marge actuelle

                    const axG = document.createElementNS(ns, "g");
                    axG.setAttribute("stroke", "#000"); axG.setAttribute("stroke-width", "1.5");

                    // --- CORRECTION: Les axes s'arr√™tent aux marges ---

                    // Axe X : De MargeGauche √† Largeur-MargeDroite
                    const xAxis = document.createElementNS(ns, "line");
                    xAxis.setAttribute("x1", m); xAxis.setAttribute("y1", ay);
                    xAxis.setAttribute("x2", this.state.width - m); xAxis.setAttribute("y2", ay);
                    xAxis.setAttribute("stroke", "#000"); xAxis.setAttribute("stroke-width", "1.5");
                    xAxis.setAttribute("marker-end", "url(#arrowhead)");
                    axG.appendChild(xAxis);

                    // Axe Y : De Hauteur-MargeBas √† MargeHaut
                    // (Attention: en SVG, Y=0 est en haut, donc on va de Height-m vers m)
                    const yAxis = document.createElementNS(ns, "line");
                    yAxis.setAttribute("x1", ax); yAxis.setAttribute("y1", this.state.height - m);
                    yAxis.setAttribute("x2", ax); yAxis.setAttribute("y2", m);
                    yAxis.setAttribute("stroke", "#000"); yAxis.setAttribute("stroke-width", "1.5");
                    yAxis.setAttribute("marker-end", "url(#arrowhead)");
                    axG.appendChild(yAxis);

                    if (this.state.showTicks) {
                        let l = this.state.layers.find(l => l.m === 1) || this.state.layers[this.state.layers.length - 1];
                        if (l) {
                            const step = l.m * this.state.baseUnit; const t = 4;
                            const offX = this.state.axisX % step;
                            let ticksPath = "";
                            for (let x = offX; x <= this.state.width; x += step) if (Math.abs(x - ax) > 2) ticksPath += `M ${Math.round(x)} ${ay - t} V ${ay + t} `;
                            const offY = this.state.axisY % step;
                            for (let y = offY; y <= this.state.height; y += step) if (Math.abs(y - ay) > 2) ticksPath += `M ${ax - t} ${Math.round(y)} H ${ax + t} `;

                            const p = document.createElementNS(ns, "path"); p.setAttribute("d", ticksPath); p.setAttribute("fill", "none");
                            axG.appendChild(p);
                        }
                    }

                    mainGroup.appendChild(axG);

                    if (this.state.showLabels) {
                        const lbG = document.createElementNS(ns, "g");
                        let l = this.state.layers.find(l => l.m === 1) || this.state.layers[this.state.layers.length - 1];
                        if (l) {
                            const step = l.m * this.state.baseUnit; const dist = this.state.labelDistance;
                            const mkLbl = (val, x, y) => {
                                const g = document.createElementNS(ns, "g"); g.setAttribute("transform", `translate(${x}, ${y})`);
                                if (this.state.labelStyle === 'badge') { const w = 12 + String(val).length * 8; const r = document.createElementNS(ns, "rect"); r.setAttribute("x", -w / 2); r.setAttribute("y", -10); r.setAttribute("width", w); r.setAttribute("height", 20); r.setAttribute("rx", 4); r.setAttribute("fill", "white"); r.setAttribute("fill-opacity", "0.85"); g.appendChild(r); }
                                const txt = document.createElementNS(ns, "text"); txt.textContent = val; txt.setAttribute("text-anchor", "middle"); txt.setAttribute("dominant-baseline", "middle"); txt.setAttribute("font-family", this.state.labelFont); txt.setAttribute("font-size", this.state.labelFontSize); g.appendChild(txt); lbG.appendChild(g);
                            };
                            const offX = this.state.axisX % step; for (let x = offX; x <= this.state.width; x += step) { const v = Math.round((x - ax) / this.state.baseUnit); if (v !== 0) mkLbl(v, x, ay + dist); }
                            const offY = this.state.axisY % step; for (let y = offY; y <= this.state.height; y += step) { const v = Math.round((ay - y) / this.state.baseUnit); if (v !== 0) mkLbl(v, ax - dist, y); }
                        }
                        mainGroup.appendChild(lbG);
                    }
                }

                // Links
                const linkG = document.createElementNS(ns, "g");
                this.state.links.forEach((lnk, i) => {
                    if (lnk.visible === false) return;
                    const p1 = this.state.points[lnk.from]; const p2 = this.state.points[lnk.to]; if (!p1 || !p2) return;
                    const x1 = this.state.axisX + p1.u * this.state.baseUnit; const y1 = this.state.axisY - p1.v * this.state.baseUnit; const x2 = this.state.axisX + p2.u * this.state.baseUnit; const y2 = this.state.axisY - p2.v * this.state.baseUnit;
                    const lg = document.createElementNS(ns, "g"); lg.style.cursor = "pointer";
                    const hb = document.createElementNS(ns, "line"); hb.setAttribute("x1", x1); hb.setAttribute("y1", y1); hb.setAttribute("x2", x2); hb.setAttribute("y2", y2); hb.setAttribute("stroke", "transparent"); hb.setAttribute("stroke-width", "15"); hb.addEventListener('contextmenu', (e) => app.showCtxMenu(e, 'link', i)); lg.appendChild(hb);
                    const line = document.createElementNS(ns, "line"); line.setAttribute("x1", x1); line.setAttribute("y1", y1); line.setAttribute("x2", x2); line.setAttribute("y2", y2); line.setAttribute("stroke", lnk.color); line.setAttribute("stroke-width", lnk.width); line.style.pointerEvents = "none"; if (lnk.dashed) line.setAttribute("stroke-dasharray", "5,5"); lg.appendChild(line);
                    if (lnk.type === 'vector') { const ang = Math.atan2(y2 - y1, x2 - x1); const head = 10 + parseInt(lnk.width); const ex = x2 - Math.cos(ang) * 3; const ey = y2 - Math.sin(ang) * 3; const arr = document.createElementNS(ns, "path"); arr.setAttribute("d", `M ${ex} ${ey} L ${ex - head * Math.cos(ang - Math.PI / 6)} ${ey - head * Math.sin(ang - Math.PI / 6)} M ${ex} ${ey} L ${ex - head * Math.cos(ang + Math.PI / 6)} ${ey - head * Math.sin(ang + Math.PI / 6)}`); arr.setAttribute("stroke", lnk.color); arr.setAttribute("stroke-width", lnk.width); arr.setAttribute("fill", "none"); arr.style.pointerEvents = "none"; lg.appendChild(arr); }
                    linkG.appendChild(lg);
                });
                mainGroup.appendChild(linkG);

                const curvesG = document.createElementNS(ns, "g");
                this.state.curves.forEach((c, i) => { if (c.visible === false) return; const d = app.getSmoothPath(c.pts); if (d) { const cg = document.createElementNS(ns, "g"); cg.style.cursor = "pointer"; const path = document.createElementNS(ns, "path"); path.setAttribute("d", d); path.setAttribute("stroke", c.color); path.setAttribute("stroke-width", c.width); path.setAttribute("fill", "none"); if (c.dashed) path.setAttribute("stroke-dasharray", "5,5"); path.addEventListener('contextmenu', (e) => app.showCtxMenu(e, 'curve', i)); cg.appendChild(path); curvesG.appendChild(cg); } });
                mainGroup.appendChild(curvesG);

                const circG = document.createElementNS(ns, "g");
                if (this.state.circles) { this.state.circles.forEach((c, i) => { if (c.visible === false) return; const p1 = this.state.points[c.center]; const p2 = this.state.points[c.edge]; if (!p1 || !p2) return; const x1 = this.state.axisX + p1.u * this.state.baseUnit; const y1 = this.state.axisY - p1.v * this.state.baseUnit; const x2 = this.state.axisX + p2.u * this.state.baseUnit; const y2 = this.state.axisY - p2.v * this.state.baseUnit; const r = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2)); const cg = document.createElementNS(ns, "g"); cg.style.cursor = "pointer"; const path = document.createElementNS(ns, "circle"); path.setAttribute("cx", x1); path.setAttribute("cy", y1); path.setAttribute("r", r); path.setAttribute("stroke", c.color); path.setAttribute("stroke-width", c.width); path.setAttribute("fill", "none"); if (c.dashed) path.setAttribute("stroke-dasharray", "5,5"); path.addEventListener('contextmenu', (e) => app.showCtxMenu(e, 'circle', i)); cg.appendChild(path); circG.appendChild(cg); }); }
                mainGroup.appendChild(circG);

                const funcsG = document.createElementNS(ns, "g");
                this.state.functions.forEach((f, i) => { if (f.visible === false) return; const fg = document.createElementNS(ns, "g"); fg.style.cursor = "pointer"; fg.addEventListener('contextmenu', (e) => app.showCtxMenu(e, 'function', i)); let d = ""; let started = false; for (let px = 0; px <= this.state.width; px += 2) { const logicalX = (px - this.state.axisX) / this.state.baseUnit; try { const logicalY = new Function('x', 'return ' + f.safeExpr)(logicalX); if (isFinite(logicalY)) { const py = this.state.axisY - logicalY * this.state.baseUnit; if (py > -100 && py < this.state.height + 100) { if (!started) { d += `M ${px} ${py}`; started = true; } else { d += ` L ${px} ${py}`; } } else { started = false; } } else { started = false; } } catch (e) { } } const path = document.createElementNS(ns, "path"); path.setAttribute("d", d); path.setAttribute("stroke", f.color); path.setAttribute("stroke-width", f.width); path.setAttribute("fill", "none"); fg.appendChild(path); funcsG.appendChild(fg); });
                mainGroup.appendChild(funcsG);

                const ptG = document.createElementNS(ns, "g");
                this.state.points.forEach((pt, i) => { if (pt.visible === false) return; const cx = this.state.axisX + pt.u * this.state.baseUnit; const cy = this.state.axisY - pt.v * this.state.baseUnit; const pg = document.createElementNS(ns, "g"); pg.setAttribute("transform", `translate(${cx}, ${cy})`); pg.style.cursor = "pointer"; const hb = document.createElementNS(ns, "circle"); hb.setAttribute("r", 15); hb.setAttribute("fill", "transparent"); hb.addEventListener('contextmenu', (e) => app.showCtxMenu(e, 'point', i)); hb.addEventListener('click', (e) => app.handlePointClick(e, i)); hb.addEventListener('mouseenter', () => { const vis = pg.querySelector('.visual-marker'); if (vis) vis.setAttribute('transform', 'scale(1.5)'); }); hb.addEventListener('mouseleave', () => { const vis = pg.querySelector('.visual-marker'); if (vis) vis.setAttribute('transform', 'scale(1)'); }); pg.appendChild(hb); if ((this.state.interactionMode === 'link' && this.state.tempLinkStart === i) || (this.state.interactionMode === 'circle' && this.state.tempLinkStart === i) || (this.state.interactionMode === 'curve' && this.state.activeCurve.includes(i))) { const halo = document.createElementNS(ns, "circle"); halo.setAttribute("r", 10); halo.setAttribute("fill", "rgba(52, 152, 219, 0.5)"); halo.style.pointerEvents = "none"; pg.appendChild(halo); } const visual = document.createElementNS(ns, "g"); visual.classList.add('visual-marker'); visual.style.pointerEvents = "none"; visual.style.transition = "transform 0.15s ease-out"; const col = this.state.tempLinkStart === i ? "#3498db" : pt.color; const s = 4; let shape = `<path d="M -${s} -${s} L ${s} ${s} M -${s} ${s} L ${s} -${s}" stroke="${col}" stroke-width="2"/>`; let tx = `<text x="6" y="-6" font-family="Arial" font-size="14" font-weight="bold" fill="${col}">${pt.label}</text>`; if (pt.showCoords) tx += `<text x="6" y="8" font-family="Arial" font-size="10" fill="#666">(${pt.u}; ${pt.v})</text>`; visual.innerHTML = shape + tx; pg.appendChild(visual); ptG.appendChild(pg); });
                mainGroup.appendChild(ptG);

                const textG = document.createElementNS(ns, "g");
                if (this.state.texts) { this.state.texts.forEach((t, i) => { if (t.visible === false) return; const cx = this.state.axisX + t.u * this.state.baseUnit; const cy = this.state.axisY - t.v * this.state.baseUnit; const tg = document.createElementNS(ns, "text"); tg.setAttribute("x", cx); tg.setAttribute("y", cy); tg.textContent = t.content; tg.setAttribute("font-family", "Arial"); tg.setAttribute("font-size", "14"); tg.setAttribute("fill", t.color); tg.style.cursor = "pointer"; tg.addEventListener('contextmenu', (e) => app.showCtxMenu(e, 'text', i)); textG.appendChild(tg); }); }
                mainGroup.appendChild(textG);

                // --- RENDU DES TABLEAUX SVG ---
                const tableG = document.createElementNS(ns, "g");
                if (this.state.tables) {
                    this.state.tables.forEach((t, i) => {
                        if (t.visible === false) return;
                        const tg = document.createElementNS(ns, "g");
                        tg.setAttribute("transform", `translate(${t.pos.x}, ${t.pos.y})`);

                        // EVENT LISTENER POUR LE DRAG DES TABLEAUX
                        tg.addEventListener('mousedown', (e) => {
                            if (app.state.interactionMode === 'move') {
                                e.stopPropagation();
                                app.drag = {
                                    active: true,
                                    mode: 'table',
                                    idx: i,
                                    startX: e.clientX,
                                    startY: e.clientY,
                                    originX: t.pos.x,
                                    originY: t.pos.y
                                };
                            } else {
                                if (e.button === 2) { // Clic droit sur tableau
                                    app.showCtxMenu(e, 'table', i);
                                }
                            }
                        });

                        const hasPrime = t.showFPrime !== false; // Default true

                        // Dimensions
                        const cellW = 50; const cellH = 30;
                        const headerW = 60;
                        const totalW = headerW + (t.x.length * 2 - 1) * cellW;
                        const totalH = hasPrime ? cellH * 3 : cellH * 2;

                        // Fond blanc + Bordure
                        const bg = document.createElementNS(ns, "rect");
                        bg.setAttribute("width", totalW); bg.setAttribute("height", totalH);
                        bg.setAttribute("fill", "white"); bg.setAttribute("stroke", "black"); bg.setAttribute("stroke-width", "1");
                        tg.appendChild(bg);

                        // Lignes horizontales
                        const l1 = document.createElementNS(ns, "line");
                        l1.setAttribute("x1", 0); l1.setAttribute("y1", cellH); l1.setAttribute("x2", totalW); l1.setAttribute("y2", cellH); l1.setAttribute("stroke", "black");
                        tg.appendChild(l1);

                        if (hasPrime) {
                            const l2 = document.createElementNS(ns, "line");
                            l2.setAttribute("x1", 0); l2.setAttribute("y1", cellH * 2); l2.setAttribute("x2", totalW); l2.setAttribute("y2", cellH * 2); l2.setAttribute("stroke", "black");
                            tg.appendChild(l2);
                        }

                        // Ligne verticale Headers
                        const lv = document.createElementNS(ns, "line");
                        lv.setAttribute("x1", headerW); lv.setAttribute("y1", 0); lv.setAttribute("x2", headerW); lv.setAttribute("y2", totalH); lv.setAttribute("stroke", "black");
                        tg.appendChild(lv);

                        // Headers Text
                        const th1 = document.createElementNS(ns, "text"); th1.textContent = "x"; th1.setAttribute("x", headerW / 2); th1.setAttribute("y", cellH / 2); th1.setAttribute("text-anchor", "middle"); th1.setAttribute("dominant-baseline", "middle"); tg.appendChild(th1);

                        if (hasPrime) {
                            const th2 = document.createElementNS(ns, "text"); th2.textContent = "f'(x)"; th2.setAttribute("x", headerW / 2); th2.setAttribute("y", cellH * 1.5); th2.setAttribute("text-anchor", "middle"); th2.setAttribute("dominant-baseline", "middle"); tg.appendChild(th2);
                            const th3 = document.createElementNS(ns, "text"); th3.textContent = "f(x)"; th3.setAttribute("x", headerW / 2); th3.setAttribute("y", cellH * 2.5); th3.setAttribute("text-anchor", "middle"); th3.setAttribute("dominant-baseline", "middle"); tg.appendChild(th3);
                        } else {
                            const th3 = document.createElementNS(ns, "text"); th3.textContent = "f(x)"; th3.setAttribute("x", headerW / 2); th3.setAttribute("y", cellH * 1.5); th3.setAttribute("text-anchor", "middle"); th3.setAttribute("dominant-baseline", "middle"); tg.appendChild(th3);
                        }

                        // Contenu X
                        let curX = headerW;
                        t.x.forEach((val, idx) => {
                            // Valeur X
                            const txt = document.createElementNS(ns, "text"); txt.textContent = val;
                            txt.setAttribute("x", curX + cellW / 2); txt.setAttribute("y", cellH / 2); txt.setAttribute("text-anchor", "middle"); txt.setAttribute("dominant-baseline", "middle");
                            tg.appendChild(txt);

                            // Ligne verticale pointill√©e sous X
                            const lvX = document.createElementNS(ns, "line");
                            lvX.setAttribute("x1", curX + cellW / 2); lvX.setAttribute("y1", cellH); lvX.setAttribute("x2", curX + cellW / 2); lvX.setAttribute("y2", totalH);
                            lvX.setAttribute("stroke", "#ccc"); lvX.setAttribute("stroke-dasharray", "4,4");
                            tg.appendChild(lvX);

                            // Valeur f'(x)
                            if (hasPrime) {
                                const fprimeVal = t.fprime[idx].val;
                                if (fprimeVal && fprimeVal !== "") {
                                    if (fprimeVal === '0' || fprimeVal === '|') {
                                        const txtP = document.createElementNS(ns, "text"); txtP.textContent = fprimeVal;
                                        txtP.setAttribute("x", curX + cellW / 2); txtP.setAttribute("y", cellH * 1.5); txtP.setAttribute("text-anchor", "middle"); txtP.setAttribute("dominant-baseline", "middle");
                                        tg.appendChild(txtP);
                                    } else if (fprimeVal === '||') {
                                        // Double barre
                                        const dbLine = document.createElementNS(ns, "line");
                                        dbLine.setAttribute("x1", curX + cellW / 2 - 2); dbLine.setAttribute("y1", cellH); dbLine.setAttribute("x2", curX + cellW / 2 - 2); dbLine.setAttribute("y2", totalH);
                                        dbLine.setAttribute("stroke", "black"); dbLine.setAttribute("stroke-width", "1");
                                        tg.appendChild(dbLine);
                                        const dbLine2 = document.createElementNS(ns, "line");
                                        dbLine2.setAttribute("x1", curX + cellW / 2 + 2); dbLine2.setAttribute("y1", cellH); dbLine2.setAttribute("x2", curX + cellW / 2 + 2); dbLine2.setAttribute("y2", totalH);
                                        dbLine2.setAttribute("stroke", "black"); dbLine2.setAttribute("stroke-width", "1");
                                        tg.appendChild(dbLine2);
                                    }
                                }
                            }

                            // Valeur f(x)
                            const fVal = t.f[idx].val;
                            const fY = hasPrime ? cellH * 2.5 : cellH * 1.5;
                            if (fVal && fVal !== "") {
                                const txtF = document.createElementNS(ns, "text"); txtF.textContent = fVal;
                                txtF.setAttribute("x", curX + cellW / 2); txtF.setAttribute("y", fY); txtF.setAttribute("text-anchor", "middle"); txtF.setAttribute("dominant-baseline", "middle");
                                tg.appendChild(txtF);
                            }

                            // Intervalle apr√®s
                            if (idx < t.x.length - 1) {
                                curX += cellW;

                                if (hasPrime) {
                                    const sign = t.fprime[idx].int;
                                    if (sign) {
                                        const txtS = document.createElementNS(ns, "text"); txtS.textContent = sign;
                                        txtS.setAttribute("x", curX + cellW / 2); txtS.setAttribute("y", cellH * 1.5); txtS.setAttribute("text-anchor", "middle"); txtS.setAttribute("dominant-baseline", "middle");
                                        tg.appendChild(txtS);
                                    }
                                }

                                // Fl√®che f(x)
                                const arr = t.f[idx].arrow;
                                if (arr) {
                                    const ax1 = curX + 10; const ax2 = curX + cellW - 10;
                                    let ay1, ay2;
                                    // Limites Y pour les fl√®ches
                                    const topY = hasPrime ? cellH * 2 + 5 : cellH + 5;
                                    const botY = totalH - 5;

                                    if (arr === 'up') { ay1 = botY; ay2 = topY; }
                                    else { ay1 = topY; ay2 = botY; }

                                    const lArr = document.createElementNS(ns, "line");
                                    lArr.setAttribute("x1", ax1); lArr.setAttribute("y1", ay1); lArr.setAttribute("x2", ax2); lArr.setAttribute("y2", ay2);
                                    lArr.setAttribute("stroke", "black"); lArr.setAttribute("marker-end", "url(#arrowhead)");
                                    tg.appendChild(lArr);
                                }
                                curX += cellW;
                            }
                        });

                        tableG.appendChild(tg);
                    });
                }
                mainGroup.appendChild(tableG);

                svg.appendChild(mainGroup);

                const gh = document.createElementNS(ns, "g"); gh.setAttribute("id", "ghost-layer");
                svg.appendChild(gh);

                // Defs pour fl√®ches SVG
                const marker = document.createElementNS(ns, "marker");
                marker.setAttribute("id", "arrowhead"); marker.setAttribute("markerWidth", "10"); marker.setAttribute("markerHeight", "7"); marker.setAttribute("refX", "9"); marker.setAttribute("refY", "3.5"); marker.setAttribute("orient", "auto");
                const poly = document.createElementNS(ns, "polygon"); poly.setAttribute("points", "0 0, 10 3.5, 0 7");
                marker.appendChild(poly); defs.appendChild(marker);

                this.ui.wrapper.insertBefore(svg, this.ui.wrapper.firstChild);
                this.renderObjectList();
            }
        };

        app.init();
    </script>
</body>

</html>
